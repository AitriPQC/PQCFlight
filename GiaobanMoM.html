<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Giao ban Tahiti ‚Äì v12m13 (Label hierarchy + Under/Over label color + Sellable by day)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<script defer src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root{
  --avg:#F28C28;    /* ƒê∆∞·ªùng TB */
  --week:#E9F4FF;   /* N·ªÅn tu·∫ßn h·ªçp */
  --wed:#FF8C00;    /* V·∫°ch giao ban */
  --occ:#0a84ff;    /* CSP */
  --adr:#2ca02c;    /* ADR */
  --rev:#0a84ff;    /* Rev bar */

  --under:#D32F2F;  /* Under label ƒë·ªè */
  --over:#FF8C00;   /* Over label cam */
  --normal:#111;    /* Label normal */
}
*{box-sizing:border-box}
body{
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  padding:12px;
  color:#111;
  background:#fff;
}
h1{margin:0 0 6px 0;font-size:22px;font-weight:800;text-align:center;}
h2{margin:0 0 10px 0;font-size:15px;font-weight:600;text-align:center;color:#333;}
.toolbar,.toolbar2,.toolbar3{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:8px 0 10px;
}
.toolbar select,.toolbar input[type="text"],.toolbar input[type="date"],.toolbar2 input[type="text"]{
  padding:6px 8px;border:1px solid #ccc;border-radius:8px;min-width:220px;
}
.toolbar button{
  padding:10px 14px;border:0;border-radius:10px;background:#111;color:#fff;cursor:pointer;
}
#chart{width:100%;height:72vh;}
#status{
  margin:8px auto;max-width:1200px;font-size:12px;color:#333;background:#f7f7f7;
  border:1px solid #e5e5e5;border-radius:8px;padding:8px;white-space:pre-wrap;
}
label{font-size:12px;color:#333}
.gb-label{color:var(--wed);font-size:11px;font-weight:700;}
.error{color:#b00020;font-weight:bold}

@media (max-width: 768px){
  body{padding:8px}
  h1{font-size:18px}
  h2{font-size:13px}
  .toolbar{gap:6px}
  .toolbar select,.toolbar input[type="date"]{min-width:150px;font-size:14px;}
  .toolbar button{padding:10px 12px;font-size:14px;}
  .toolbar2{display:none;}
  .toolbar3 label{font-size:13px}
  #chart{height:70vh}
}
@media (max-width: 480px){
  .toolbar{justify-content:space-between}
  .toolbar > *{flex:1 1 48%}
  .toolbar button{flex:1 1 100%}
  #chart{height:68vh}
}

#preloader{
  position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;
  font-weight:700;font-size:18px;z-index:9999;
}
.spinner{
  width:18px;height:18px;border-radius:50%;border:3px solid #ddd;border-top-color:#111;
  margin-right:10px;animation:spin 0.9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Monthly summary table */
.monthly-summary{margin:10px auto 6px;max-width:1200px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.monthly-summary .ms-title{font-size:13px;font-weight:800;margin:0 0 6px 0;color:#111;text-align:center;}
.ms-meta{margin-top:8px;font-size:12px;color:#444;text-align:right;}
.monthly-summary table{
  width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid #e5e5e5;
  border-radius:10px;overflow:hidden;
}
.monthly-summary th,.monthly-summary td{padding:10px 10px;border-bottom:1px solid #eee;font-size:12px;white-space:nowrap;}
.monthly-summary th{background:#fafafa;font-weight:800;color:#222;text-align:center;}
.monthly-summary td{text-align:right;}
.monthly-summary td:first-child{text-align:left;font-weight:700;}
.monthly-summary tr:last-child td{border-bottom:0;}
.ms-pos{color:#1a7f37;font-weight:800;}
.ms-neg{color:#b00020;font-weight:800;}
.ms-na{color:#777;font-weight:700;}
.ms-g1{background:#F3FAFF;}
.ms-g2{background:#FFF7ED;}
.ms-g3{background:#F5F3FF;}
.ms-delta{font-weight:800;}
@media (max-width:768px){
  .monthly-summary th,.monthly-summary td{font-size:12px;padding:9px 8px;}
  .monthly-summary .ms-title{font-size:12px}
}
</style>
</head>
<body>
<div id="preloader"><div class="spinner"></div>ƒêang kh·ªüi t·∫°o bi·ªÉu ƒë·ªì‚Ä¶</div>

<h1 id="titleH1">TAHITI BEACH HOTEL</h1>
<h2 id="titleH2">Briefing view ‚Äì Tu·∫ßn tr∆∞·ªõc, tu·∫ßn n√†y v√† 2 tu·∫ßn k·∫ø ti·∫øp</h2>

<div class="toolbar">
  <label>C∆° s·ªü:</label>
  <select id="hotelSelect">
    <option value="TBH">Tahiti Beach Hotel</option>
    <option value="TR">Tahiti Resort</option>
    <option value="TC">Tahiti Central</option>
    <option value="HTR">H·ªìng Tuy·∫øt Riverside</option>
  </select>

  <label>Ch·∫ø ƒë·ªô hi·ªÉn th·ªã:</label>
  <select id="modeSelect">
    <option value="BRIEFING" selected>Briefing view</option>
    <option value="MONTHLY">Monthly view</option>
  </select>

  <label>Ch·ªçn ng√†y:</label>
  <input id="meetingDate" type="date" />

  <button id="renderBtn">V·∫Ω l·∫°i</button>
  <button id="exportBtn">üñºÔ∏è T·∫£i PNG (·∫©n summary)</button>
</div>

<div class="toolbar2">
  <label>Google Sheets CSV (t√πy ch·ªânh):</label>
  <input id="csvUrl" type="text" placeholder="(Tu·ª≥ ch·ªçn) D√°n link CSV kh√°c n·∫øu mu·ªën‚Ä¶">
</div>

<div class="toolbar3">
  <label><input id="toggleCSP" type="checkbox" checked> Hi·ªÉn th·ªã CSP</label>
  <label><input id="toggleADR" type="checkbox"> Hi·ªÉn th·ªã ADR</label>
  <label><input id="toggleREV" type="checkbox"> Hi·ªÉn th·ªã Room Revenue</label>
  <label><input id="toggleGBLabel" type="checkbox" checked> Hi·ªÉn th·ªã ch·ªØ "Giao ban"</label>
</div>

<div id="monthlySummary" class="monthly-summary" style="display:none"></div>
<div id="chart"></div>
<div id="status">
  v12m13: Sellable theo ng√†y (Rooms Available). Label ph√¢n c·∫•p: CSP% bold; Occupied/Available nh·ªè + italic (kh√¥ng kho·∫£ng tr·∫Øng). Under&lt;50 = ƒë·ªè; Over&gt;100 = cam. Kh√¥ng t√¥ n·ªÅn Under/Over.
</div>

<script>
const PRESETS = {
  "TBH": {
    title: "TAHITI BEACH HOTEL",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=1366109607&single=true&output=csv"
  },
  "TR": {
    title: "TAHITI RESORT",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=1949035251&single=true&output=csv"
  },
  "TC": {
    title: "TAHITI CENTRAL",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=742745253&single=true&output=csv"
  },
  "HTR": {
    title: "H·ªíNG TUY·∫æT RIVERSIDE",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=626348031&single=true&output=csv"
  }
};

let _annotationsBackup=null, _summaryIndex=null;

/* Helpers */
function setStatus(msg,isError){
  const el=document.getElementById('status');
  el.innerHTML=(isError?'<span class="error">L·ªñI: </span>':'')+msg;
}
function splitLines(t){return t.replace(/\r/g,'').split('\n');}
function parseCSV(text){
  const lines=splitLines(text).filter(l=>l!=null && String(l).trim()!=='');
  if(lines.length===0) return {headers:[],rows:[],meta:{exportTime:null,source:null}};
  const norm=s=>String(s||'').toLowerCase().replace(/\s+/g,' ').trim();
  let headerIdx=0;
  for(let i=0;i<Math.min(lines.length,60);i++){
    const cols=lines[i].split(',').map(s=>s.trim());
    const hasDate = cols.some(c=>norm(c)==='date');
    const hasOcc  = cols.some(c=>norm(c)==='occupancy');
    if(hasDate && hasOcc){ headerIdx=i; break; }
  }

  const metaLines = lines.slice(0,headerIdx).join(' | ');
  const meta = { exportTime:null, source:'PMS EzCloud' };

  const dtRegex = /(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})\s+(\d{1,2}:\d{2}(?::\d{2})?)/;
  const m = metaLines.match(dtRegex);
  if(m){
    let d=m[1], t=m[2];
    if(/^\d{4}[\/\-]/.test(d)){
      const parts=d.split(/[\/\-]/).map(x=>parseInt(x,10));
      const yy=parts[0], mm=('0'+parts[1]).slice(-2), dd=('0'+parts[2]).slice(-2);
      d=`${dd}/${mm}/${yy}`;
    }else{
      const parts=d.split(/[\/\-]/).map(x=>parseInt(x,10));
      if(parts.length===3){
        const dd=('0'+parts[0]).slice(-2), mm=('0'+parts[1]).slice(-2);
        let yy=parts[2]; if(yy<100) yy+=2000;
        d=`${dd}/${mm}/${yy}`;
      }
    }
    meta.exportTime = `${d} ${t}`;
  }

  const headers=lines[headerIdx].split(',').map(s=>s.trim());
  const rows=[];
  for(let i=headerIdx+1;i<lines.length;i++){
    const cols=lines[i].split(',');
    const row={};
    for(let j=0;j<headers.length;j++){
      row[headers[j]]=(cols[j]||'').trim();
    }
    rows.push(row);
  }
  return {headers,rows,meta};
}
function parseDate(s){
  if(!s) return null;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){
    const dd=+s.slice(0,2),mm=+s.slice(3,5),yy=+s.slice(6,10);
    return new Date(yy,mm-1,dd);
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const yy=+s.slice(0,4),mm=+s.slice(5,7),dd=+s.slice(8,10);
    return new Date(yy,mm-1,dd);
  }
  const d=new Date(s);
  return isNaN(d.getTime())?null:d;
}
function numPercent(v){
  if(v==null) return null;
  let s=String(v).replace(/[^0-9.-]/g,''), n=parseFloat(s);
  if(isNaN(n)) return null;
  if(n<1) n*=100;
  return Math.round(n);
}
function numMoney(v){
  if(v==null) return null;
  let s=String(v).replace(/[^0-9-]/g,'');
  if(!s) return null;
  return parseInt(s,10);
}
function fmtDDMM(d){
  const dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2);
  return dd+'/'+mm;
}
function fmtDDMMYYYY(d){
  const dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear();
  return dd+'/'+mm+'/'+yy;
}
function fmtMonthYYYY(d){
  const mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear();
  return mm+'/'+yy;
}
function fmtMil(n){
  if(n==null || isNaN(n)) return '';
  return (n/1e6).toFixed(1).replace(/\.0$/,'')+'M';
}
function fmtMilADR(n){
  if(n==null || isNaN(n)) return '';
  return (n/1e6).toFixed(2)+'M';
}
function viMoney(n){
  try{return Number(n||0).toLocaleString('vi-VN');}
  catch(e){return n;}
}

/* Monthly summary helpers (unchanged) */
function monthKey(y,m){ return y+'-'+('0'+(m+1)).slice(-2); }
function monthLabel(y,m){ return ('0'+(m+1)).slice(-2)+'/'+y; }
function monthRange(y,m){
  const start=new Date(y,m,1);
  const end=new Date(y,m+1,0);
  end.setHours(23,59,59,999);
  return {start,end};
}
function prevMonth(y,m){ return (m===0)?{y:y-1,m:11}:{y:y,m:m-1}; }
function yoyMonth(y,m){ return {y:y-1,m:m}; }
function calcMonthMetrics(arr,y,m){
  const r=monthRange(y,m);
  const inMonth=arr.filter(o=>o.d>=r.start && o.d<=r.end);
  const occVals=inMonth.map(o=>o.occ).filter(v=>v!=null && isFinite(v));
  const adrVals=inMonth.map(o=>o.adr).filter(v=>v!=null && isFinite(v));
  const revVals=inMonth.map(o=>o.rev).filter(v=>v!=null && isFinite(v));
  const avgOcc = occVals.length ? (occVals.reduce((a,b)=>a+b,0)/occVals.length) : null;
  const avgADR = adrVals.length ? (adrVals.reduce((a,b)=>a+b,0)/adrVals.length) : null;
  const sumRev = revVals.length ? (revVals.reduce((a,b)=>a+b,0)) : null;
  return {avgOcc, avgADR, sumRev, label: monthLabel(y,m), key: monthKey(y,m)};
}
function pctChange(cur,base){
  if(cur==null || base==null) return null;
  if(!isFinite(cur) || !isFinite(base) || base===0) return null;
  return (cur-base)/base*100;
}
function fmtPct(p){
  if(p==null || !isFinite(p)) return '‚Äî';
  const n=Math.round(p);
  const sign = n>0 ? '+' : (n<0 ? '-' : '');
  return sign + Math.abs(n).toFixed(0) + '%';
}
function fmtMoneySigned(v){
  if(v==null || !isFinite(v)) return '‚Äî';
  const n=Math.round(v);
  const sign = n>0 ? '+' : (n<0 ? '-' : '');
  return sign+viMoney(Math.abs(n));
}
function fmtPctWithMoney(p,deltaMoney){
  if(p==null || !isFinite(p) || deltaMoney==null || !isFinite(deltaMoney)) return '‚Äî';
  return `${fmtPct(p)} (${fmtMoneySigned(deltaMoney)})`;
}
function clsPct(p){
  if(p==null || !isFinite(p)) return 'ms-na';
  if(p>0) return 'ms-pos';
  if(p<0) return 'ms-neg';
  return 'ms-na';
}
function fmtOcc(v){ return (v==null || !isFinite(v)) ? '‚Äî' : (Math.round(v)+'%'); }
function fmtMoneyOrNA(v){ return (v==null || !isFinite(v)) ? '‚Äî' : viMoney(Math.round(v)); }

function renderMonthlySummaryTable(win,arr,meta){
  const box=document.getElementById('monthlySummary');
  if(!box) return;
  if(!win || !win.monthly){ box.style.display='none'; box.innerHTML=''; return; }

  const y=win.start.getFullYear();
  const m=win.start.getMonth();
  const pm=prevMonth(y,m);
  const yy=yoyMonth(y,m);

  const cur=calcMonthMetrics(arr,y,m);
  const prev=calcMonthMetrics(arr,pm.y,pm.m);
  const yoy=calcMonthMetrics(arr,yy.y,yy.m);

  const momOcc = (cur.avgOcc==null||prev.avgOcc==null)?null:(Math.round(cur.avgOcc) - Math.round(prev.avgOcc));
  const yoyOcc = (cur.avgOcc==null||yoy.avgOcc==null)?null:(Math.round(cur.avgOcc) - Math.round(yoy.avgOcc));

  const momADR=pctChange(cur.avgADR, prev.avgADR);
  const yoyADR=pctChange(cur.avgADR, yoy.avgADR);
  const dAdrMom=(cur.avgADR==null||prev.avgADR==null)?null:(cur.avgADR-prev.avgADR);
  const dAdrYoy=(cur.avgADR==null||yoy.avgADR==null)?null:(cur.avgADR-yoy.avgADR);

  const momRev=pctChange(cur.sumRev, prev.sumRev);
  const yoyRev=pctChange(cur.sumRev, yoy.sumRev);
  const dRevMom=(cur.sumRev==null||prev.sumRev==null)?null:(cur.sumRev-prev.sumRev);
  const dRevYoy=(cur.sumRev==null||yoy.sumRev==null)?null:(cur.sumRev-yoy.sumRev);

  const metaHTML = (meta && meta.exportTime)
    ? `<div class="ms-meta">Ngu·ªìn d·ªØ li·ªáu: ${meta.source||'PMS'} ¬∑ Export: ${meta.exportTime}</div>`
    : `<div class="ms-meta">Ngu·ªìn d·ªØ li·ªáu: ${(meta&&meta.source)?meta.source:'PMS'} ¬∑ Export: ‚Äî</div>`;

  const html = `
    <div class="ms-title">Monthly Summary ‚Äì ${cur.label}</div>
    <table>
      <thead>
        <tr>
          <th>Ch·ªâ ti√™u</th>
          <th class="ms-g1">Th√°ng hi·ªán t·∫°i (${cur.label})</th>
          <th class="ms-g2">Th√°ng tr∆∞·ªõc (${prev.label})</th>
          <th class="ms-g2">TƒÉng / gi·∫£m MoM</th>
          <th class="ms-g3">C√πng k·ª≥ nƒÉm tr∆∞·ªõc (${yoy.label})</th>
          <th class="ms-g3">TƒÉng / gi·∫£m YoY</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>C√¥ng su·∫•t ph√≤ng (CSP)</td>
          <td class="ms-g1">${fmtOcc(cur.avgOcc)}</td>
          <td class="ms-g2">${fmtOcc(prev.avgOcc)}</td>
          <td class="ms-g2 ${clsPct(momOcc)} ms-delta">${fmtPct(momOcc)}</td>
          <td class="ms-g3">${fmtOcc(yoy.avgOcc)}</td>
          <td class="ms-g3 ${clsPct(yoyOcc)} ms-delta">${fmtPct(yoyOcc)}</td>
        </tr>
        <tr>
          <td>B√¨nh qu√¢n ADR (VND)</td>
          <td class="ms-g1">${fmtMoneyOrNA(cur.avgADR)}</td>
          <td class="ms-g2">${fmtMoneyOrNA(prev.avgADR)}</td>
          <td class="ms-g2 ${clsPct(momADR)} ms-delta">${fmtPctWithMoney(momADR,dAdrMom)}</td>
          <td class="ms-g3">${fmtMoneyOrNA(yoy.avgADR)}</td>
          <td class="ms-g3 ${clsPct(yoyADR)} ms-delta">${fmtPctWithMoney(yoyADR,dAdrYoy)}</td>
        </tr>
        <tr>
          <td>T·ªïng doanh thu (VND)</td>
          <td class="ms-g1">${fmtMoneyOrNA(cur.sumRev)}</td>
          <td class="ms-g2">${fmtMoneyOrNA(prev.sumRev)}</td>
          <td class="ms-g2 ${clsPct(momRev)} ms-delta">${fmtPctWithMoney(momRev,dRevMom)}</td>
          <td class="ms-g3">${fmtMoneyOrNA(yoy.sumRev)}</td>
          <td class="ms-g3 ${clsPct(yoyRev)} ms-delta">${fmtPctWithMoney(yoyRev,dRevYoy)}</td>
        </tr>
      </tbody>
    </table>
    ${metaHTML}
  `;
  box.innerHTML = html;
  box.style.display = 'block';
}

function getKey(headers,target){
  const norm=s=>s.toLowerCase().replace(/\s+/g,' ').trim();
  const want=norm(target);
  for(const h of headers){ if(norm(h)===want) return h; }
  return null;
}
function lastWednesday(date){
  const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
  const day=d.getDay();
  const diff=(day>=3)?day-3:day+4;
  d.setDate(d.getDate()-diff);
  return d;
}
function makeWindows(viewMode,pickStr){
  const day=24*3600*1000;
  if(viewMode==='MONTHLY' && pickStr){
    const d=parseDate(pickStr); if(!d) return null;
    if(d.getDate()===1){
      const end=new Date(d.getFullYear(),d.getMonth()+1,0);
      return {start:d,end:end,title:'Monthly view ‚Äì Th√°ng '+fmtMonthYYYY(d),monthly:true,monthText:fmtMonthYYYY(d)};
    }else{
      const end=new Date(d.getTime()+30*day);
      return {start:d,end:end,title:'Monthly view ('+fmtDDMM(d)+' ‚Üí '+fmtDDMM(end)+')',monthly:true,monthText:fmtMonthYYYY(d)};
    }
  }
  let meeting=pickStr?parseDate(pickStr):lastWednesday(new Date());
  if(!meeting) meeting=lastWednesday(new Date());
  const specialEnd = (pickStr && meeting.getDate && meeting.getDate()===8);
  const end = specialEnd
    ? new Date(meeting.getFullYear(), meeting.getMonth()+1, 0)
    : new Date(meeting.getTime()+21*day);

  return {
    start:new Date(meeting.getTime()-7*day),
    end:end,
    title:'Briefing view ‚Äì Tu·∫ßn tr∆∞·ªõc, tu·∫ßn n√†y v√† 2 tu·∫ßn k·∫ø ti·∫øp',
    monthly:false,
    meeting,
    specialEnd
  };
}

/* Color rule */
function cspColor(v){
  if(v < 60)  return '#D32F2F'; // UNDER <60% -> ƒë·ªè
  return '#111';
}


/* Render */
async function render(){
  try{
    const sel=document.getElementById('hotelSelect').value;
    const preset=PRESETS[sel];
    document.getElementById('titleH1').innerText=preset.title;

    const csvInput=document.getElementById('csvUrl');
    if(!csvInput.value) csvInput.value=preset.csv;
    const csvUrl=csvInput.value.trim();

    const viewMode=document.getElementById('modeSelect').value;
    const pickStr=document.getElementById('meetingDate').value;
    const showCSP=document.getElementById('toggleCSP').checked;
    const showADR=document.getElementById('toggleADR').checked;
    const showREV=document.getElementById('toggleREV').checked;
    const showGBLabel=document.getElementById('toggleGBLabel').checked;

    setStatus('ƒêang t·∫£i CSV‚Ä¶\n'+csvUrl);

    const res=await fetch(csvUrl,{cache:'no-store'});
    if(!res.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c CSV. HTTP '+res.status);
    const raw=await res.text();
    const parsed=parseCSV(raw);
    const {headers,rows,meta}=parsed;
    window.__CSV_META__ = meta;

    const kDate=getKey(headers,'Date');
    const kOccRooms=getKey(headers,'Occupied');
    const kOccPct=getKey(headers,'Occupancy');
    const kRev=getKey(headers,'Room Revenue');
    const kADR=getKey(headers,'ADR');
    const kAvail=getKey(headers,'Rooms Available'); // Sellable theo ng√†y

    if(!kDate||!kOccRooms||!kOccPct){
      throw new Error('Thi·∫øu c·ªôt b·∫Øt bu·ªôc: Date, Occupied, Occupancy.\nHeaders: '+headers.join(' | '));
    }
    if(!kAvail){
      setStatus(
        'C·∫£nh b√°o: kh√¥ng th·∫•y c·ªôt "Rooms Available".\n' +
        'Label s·∫Ω hi·ªÉn th·ªã Occupied (ph√≤ng) nh∆∞ng kh√¥ng c√≥ m·∫´u s·ªë sellable.\n' +
        'Headers: '+headers.join(' | ')
      );
    }

    const arr=[];
    for(const r of rows){
      const d=parseDate(r[kDate]); if(!d) continue;
      const occ=numPercent(r[kOccPct]);
      const occRooms=numMoney(r[kOccRooms]);
      const avail=kAvail?numMoney(r[kAvail]):null;
      const adr=kADR?numMoney(r[kADR]):null;
      const rev=kRev?numMoney(r[kRev]):null;
      arr.push({d,occ,occRooms,avail,adr,rev});
    }
    if(arr.length===0) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá.');
    arr.sort((a,b)=>a.d-b.d);

    const win=makeWindows(viewMode,pickStr);
    if(!win) throw new Error('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c c·ª≠a s·ªï d·ªØ li·ªáu.');
    const data=arr.filter(o=>o.d>=win.start && o.d<=win.end);
    if(data.length===0) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu trong c·ª≠a s·ªï ƒë√£ ch·ªçn.');

    const dates=data.map(o=>o.d);
    const occ=data.map(o=>o.occ);
    const rooms=data.map(o=>o.occRooms);
    const avail=data.map(o=>o.avail);
    const adrVals=data.map(o=>o.adr);
    const revVals=data.map(o=>o.rev);

    const hasAdrData=adrVals.some(v=>v!=null && !isNaN(v));
    const hasRevData=revVals.some(v=>v!=null && !isNaN(v));

    const useCSP = showCSP;
    const useADR = showADR && hasAdrData;
    const useREV = showREV && hasRevData;
    const useMoney = useADR || useREV;
    const triple = useCSP && useADR && useREV;

    const traces=[];
    const shapes=[];
    const annotations=[];
    // --- Threshold & Monthly AVG (used for TB line color and legend) ---
    const underThreshold = 60; // fixed
    const occValid = occ.filter(v=>v!=null && isFinite(v));
    const avgOccAll = occValid.length ? Math.round(occValid.reduce((a,b)=>a+b,0)/occValid.length) : 0;
    const avgColor = (avgOccAll < underThreshold)
      ? '#111'
      : getComputedStyle(document.documentElement).getPropertyValue('--avg').trim();


    document.getElementById('titleH2').innerText=win.title;

    /* --- Traces --- */

    // Room Revenue
    if(useREV){
      let yaxisRev='y';
      if(triple || (useCSP && useREV && !useADR)) yaxisRev='y2';
      traces.push({
        x:dates,y:revVals,type:'bar',name:'Room Revenue (VND/ng√†y)',
        marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim()},
        opacity:0.95,
        text:revVals.map(v=>(v||v===0)?fmtMil(v):''),
        textposition:'outside',
        textfont:{size:12},
        yaxis:yaxisRev
      });
    }

    // ADR
    if(useADR){
      let yaxisADR='y';
      if(triple) yaxisADR='y3';
      else if(useCSP && useADR && !useREV) yaxisADR='y2';
      else if(!useCSP && useADR && useREV) yaxisADR='y2';

      const textShort=adrVals.map(v=>v!=null?fmtMilADR(v):'');
      const hoverData=adrVals.map((v,i)=>v!=null
        ?('<b>'+fmtDDMM(dates[i])+'</b><br>ADR: '+viMoney(v)+' VND')
        :'');
      traces.push({
        x:dates,y:adrVals,type:'scatter',mode:'lines+markers+text',name:'ADR (VND)',
        line:{width:2,color:getComputedStyle(document.documentElement).getPropertyValue('--adr').trim()},
        marker:{size:6,color:getComputedStyle(document.documentElement).getPropertyValue('--adr').trim()},
        text:textShort,textposition:'top center',textfont:{size:10},
        hovertemplate:'%{customdata}<extra></extra>',customdata:hoverData,
        yaxis:yaxisADR
      });
    }

    // CSP with hierarchical label (bold % ; small italic rooms with no spaces around "/")
    if(useCSP){
      const labels = occ.map((v,i)=>{
        if(v==null) return '';
        const r = Math.round(rooms[i]||0);
        const a = (avail[i]!=null) ? Math.round(avail[i]||0) : null;

        const line1 = `<b>${v}%</b>`;
        const line2 = (a!=null && a>0)
          ? `<span style="font-size:9px;"><i>${r}/${a}</i></span>`
          : `<span style="font-size:9px;"><i>${r}</i></span>`;
        return line1 + '<br>' + line2;
      });

      const textpos=occ.map(v=>v>90?'bottom center':'top center');
      const colors = occ.map(v => cspColor(v));

      traces.push({
        x:dates,y:occ,type:'scatter',mode:'lines+markers+text',name:'C√¥ng su·∫•t ph√≤ng (%)',
        line:{width:2,color:getComputedStyle(document.documentElement).getPropertyValue('--occ').trim()},
        marker:{size:6,color:getComputedStyle(document.documentElement).getPropertyValue('--occ').trim()},
        text:labels,
        textposition:textpos,
        textfont:{size:12,family:'Arial',color:colors}, // per-point label color
        yaxis:'y'
      });
    }

    /* --- Title annotations --- */
    const hotelTitle=PRESETS[sel].title;
    if(viewMode==='BRIEFING'){
      const l1='<span style="font-size:16px;font-weight:800;">'+hotelTitle+'</span>';
      const l2='<span style="font-size:12px;font-weight:600;">Briefing view ‚Äì t·ª´ '+fmtDDMMYYYY(win.start)+' ƒë·∫øn '+fmtDDMMYYYY(win.end)+'</span>';
      annotations.push({x:0,y:1.13,xref:'paper',yref:'paper',xanchor:'left',yanchor:'top',showarrow:false,text:l1+'<br>'+l2});
    }else{
      const l1='<span style="font-size:16px;font-weight:800;">'+hotelTitle+'</span>';
      const l2='<span style="font-size:12px;font-weight:600;">Monthly view ‚Äì Th√°ng '+win.monthText+'</span>';
      annotations.push({x:0,y:1.13,xref:'paper',yref:'paper',xanchor:'left',yanchor:'top',showarrow:false,text:l1+'<br>'+l2});
    }

    /* --- Briefing background & lines & weekly averages --- */
    if(viewMode==='BRIEFING'){
      const day=24*3600*1000;
      const meeting=win.meeting;

      // N·ªÅn tu·∫ßn h·ªçp
      shapes.push({
        type:'rect',xref:'x',yref:'paper',
        x0:meeting,x1:new Date(meeting.getTime()+7*day),
        y0:0,y1:1,
        fillcolor:getComputedStyle(document.documentElement).getPropertyValue('--week').trim(),
        opacity:0.35,line:{width:0}
      });

      // V·∫°ch giao ban + label (toggle)
      const marks=[
        new Date(meeting.getTime()-7*day),
        meeting,
        new Date(meeting.getTime()+7*day),
        new Date(meeting.getTime()+14*day)
      ];
      if(!win.specialEnd){ marks.push(new Date(meeting.getTime()+21*day)); }
      for(const d of marks){
        shapes.push({
          type:'line',xref:'x',yref:'paper',
          x0:d,x1:d,y0:0,y1:1,
          line:{color:getComputedStyle(document.documentElement).getPropertyValue('--wed').trim(),width:1.5,dash:'dash'}
        });
        if(showGBLabel){
          annotations.push({
            x:d,y:0,xref:'x',yref:'paper',showarrow:false,
            text:'<span class="gb-label">Giao ban</span>',textangle:-90,yshift:18
          });
        }
      }

      // ƒê∆∞·ªùng TB tu·∫ßn (CSP nh∆∞ c≈©, ADR-only gi·ªØ logic c≈©)
function avgOcc(s,e){
        let sum=0,n=0;
        for(let i=0;i<dates.length;i++){
          if(dates[i]>=s && dates[i]<=e && occ[i]!=null){sum+=occ[i];n++;}
        }
        return n?sum/n:null;
      }
      function avgADRVal(s,e){
        let sum=0,n=0;
        for(let i=0;i<dates.length;i++){
          if(dates[i]>=s && dates[i]<=e && adrVals[i]!=null){sum+=adrVals[i];n++;}
        }
        return n?sum/n:null;
      }
      const segs=[
        {s:new Date(meeting.getTime()-7*day), e:meeting},
        {s:meeting, e:new Date(meeting.getTime()+7*day)},
        {s:new Date(meeting.getTime()+7*day), e:new Date(meeting.getTime()+14*day)},
        {s:new Date(meeting.getTime()+14*day), e:(win.specialEnd?win.end:new Date(meeting.getTime()+21*day))}
      ];

      if(useCSP){
        for(const S of segs){
          const a=avgOcc(S.s,S.e);
          if(a==null) continue;
          const xs=S.s<dates[0]?dates[0]:S.s;
          const xe=S.e>dates[dates.length-1]?dates[dates.length-1]:S.e;
          shapes.push({type:'line',xref:'x',yref:'y',x0:xs,x1:xe,y0:a,y1:a,line:{color:avgColor,width:2}});
          annotations.push({
            x:xe,y:a,xref:'x',yref:'y',
            axref:'x',ayref:'y',ax:xs,ay:a,
            showarrow:true,arrowside:'end+start',
            arrowhead:3,startarrowhead:3,
            arrowwidth:1.6,arrowcolor:avgColor,text:''
          });
          annotations.push({
            x:xs,y:a,xref:'x',yref:'y',showarrow:false,
            text:'<span style="color:'+avgColor+';font-weight:800;font-family:Arial Black;">TB: '+Math.round(a)+'%</span>',
            xanchor:'left',yanchor:'bottom',xshift:6
          });
        }
      } else if(!useCSP && useADR && !useREV){
        for(const S of segs){
          const a=avgADRVal(S.s,S.e);
          if(a==null) continue;
          const xs=S.s<dates[0]?dates[0]:S.s;
          const xe=S.e>dates[dates.length-1]?dates[dates.length-1]:S.e;
          shapes.push({type:'line',xref:'x',yref:'y',x0:xs,x1:xe,y0:a,y1:a,line:{color:avgColor,width:2}});
          annotations.push({
            x:xe,y:a,xref:'x',yref:'y',
            axref:'x',ayref:'y',ax:xs,ay:a,
            showarrow:true,arrowside:'end+start',
            arrowhead:3,startarrowhead:3,
            arrowwidth:1.6,arrowcolor:avgColor,text:''
          });
          annotations.push({
            x:xs,y:a,xref:'x',yref:'y',showarrow:false,
            text:'<span style="color:'+avgColor+';font-weight:800;font-family:Arial Black;">TB: '+fmtMilADR(a)+'</span>',
            xanchor:'left',yanchor:'bottom',xshift:6
          });
        }
      }
    }

        /* --- Summary --- */
const avgADRAll = hasAdrData
      ? Math.round(adrVals.filter(v=>v!=null).reduce((a,b)=>a+b,0)/adrVals.filter(v=>v!=null).length)
      : null;

    const sumRevAll = hasRevData ? revVals.filter(v=>v!=null).reduce((a,b)=>a+b,0) : null;
    const summaryHTML =
      '<span style="color:#111;font-weight:700;">B√¨nh qu√¢n CSP: '+(isFinite(avgOccAll)?avgOccAll:0)+'%</span>'
      +' &nbsp; | &nbsp; <span style="color:#2ca02c;font-weight:700;">B√¨nh qu√¢n ADR: '+(avgADRAll!=null?viMoney(avgADRAll):'‚Äî')+' VND</span>'
      +' &nbsp; | &nbsp; <span style="color:#0057D9;font-weight:800;">T·ªïng DT d·ª± ki·∫øn: '+(sumRevAll!=null?viMoney(sumRevAll):'‚Äî')+' VND</span>'
      +' &nbsp; | &nbsp; <span style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--under').trim()+';font-weight:800;">M√†u ƒë·ªè: CSP < '+underThreshold+'%</span>';
    const summaryHTML_anno = isMobile()
      ? ('<span style="color:#111;font-weight:700;">CSP: '+(isFinite(avgOccAll)?avgOccAll:0)+'%</span>'
        +' &nbsp; | &nbsp; <span style="color:#2ca02c;font-weight:700;">ADR: '+(avgADRAll!=null?viMoney(avgADRAll):'‚Äî')+'</span>'
        +'<br><span style="color:#0057D9;font-weight:800;">DT: '+(sumRevAll!=null?viMoney(sumRevAll):'‚Äî')+'</span>'
        +' &nbsp; | &nbsp; <span style="color:'+getComputedStyle(document.documentElement).getPropertyValue('--under').trim()+';font-weight:800;">CSP < '+underThreshold+'% = ƒë·ªè</span>')
      : summaryHTML;

    const summaryAnnotation={
      x:1,y:1.13,xref:'paper',yref:'paper',
      xanchor:'right',yanchor:'top',
      text:summaryHTML_anno,showarrow:false,
      font:{size:(isMobile()?12:13),family:'Arial'},
      bgcolor:'rgba(255,255,255,0.9)',
      borderpad:2
    };
    annotations.push(summaryAnnotation);
    _summaryIndex=annotations.length-1;

    /* --- Layout & axis titles theo t·ªï h·ª£p --- */
    const layout={
      margin:{l:70,r:70,t:(isMobile()?105:90),b:60},
      xaxis:{
        tickmode:'array',
        tickvals:dates,
        ticktext:dates.map(fmtDDMM),
        tickangle:-45,
        showgrid:true,
        gridcolor:'rgba(0,0,0,0.15)'
      },
      shapes:shapes, // no Under/Over highlight shapes
      annotations:annotations,
      showlegend:true,
      legend:{x:1,y:1,xanchor:'right',yanchor:'top',bgcolor:'rgba(255,255,255,0.85)'}
    };

    if(triple){
      layout.yaxis = {title:'C√¥ng su·∫•t ph√≤ng (%)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
      layout.yaxis2 = {title:'Room Revenue (VND/ng√†y)',anchor:'x',overlaying:'y',side:'right',rangemode:'tozero',position:1};
      layout.yaxis3 = {title:'ADR (VND)',anchor:'x',overlaying:'y',side:'right',rangemode:'tozero',position:0.9};
    } else if(useCSP && useREV && !useADR){
      layout.yaxis = {title:'C√¥ng su·∫•t ph√≤ng (%)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
      layout.yaxis2 = {title:'Room Revenue (VND/ng√†y)',anchor:'x',overlaying:'y',side:'right',rangemode:'tozero',position:1};
    } else if(useCSP && useADR && !useREV){
      layout.yaxis = {title:'C√¥ng su·∫•t ph√≤ng (%)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
      layout.yaxis2 = {title:'ADR (VND)',anchor:'x',overlaying:'y',side:'right',rangemode:'tozero',position:1};
    } else if(!useCSP && useADR && useREV){
      layout.yaxis = {title:'Room Revenue (VND/ng√†y)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
      layout.yaxis2 = {title:'ADR (VND)',anchor:'x',overlaying:'y',side:'right',rangemode:'tozero',position:1};
    } else if(!useCSP && useADR && !useREV){
      layout.yaxis = {title:'ADR (VND)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
    } else if(!useCSP && useREV && !useADR){
      layout.yaxis = {title:'Room Revenue (VND/ng√†y)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
    } else if(useCSP && !useMoney){
      layout.yaxis = {title:'C√¥ng su·∫•t ph√≤ng (%)',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
    } else {
      layout.yaxis = {title:'',rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'};
    }

    await Plotly.newPlot('chart',traces,layout,{responsive:true,displaylogo:false});
    _annotationsBackup=annotations.map(a=>Object.assign({},a));

    renderMonthlySummaryTable(win,arr, window.__CSV_META__);

    const pr=document.getElementById('preloader');
    if(pr) pr.style.display='none';

    setStatus(
      'CSV OK. '+win.title+
      '\nCSP='+showCSP+' | ADR='+showADR+' | REV='+showREV+
      '\nRooms Available column: '+(kAvail? 'YES':'NO')+
      '\nLabel color rule: Under<50=RED | Over>100=ORANGE | Normal=BLACK. (No background highlights).'
    );
  }catch(err){
    console.error(err);
    setStatus(err.message,true);
    const ms=document.getElementById('monthlySummary'); if(ms){ ms.style.display='none'; ms.innerHTML=''; }
    const pr=document.getElementById('preloader'); if(pr) pr.style.display='none';
  }
}

/* Export PNG (·∫©n summary) */
async function exportPNG(){
  try{
    const gd=document.getElementById('chart');
    if(_summaryIndex==null || !_annotationsBackup){
      await Plotly.downloadImage(gd,{format:'png',filename:'chart'});
      return;
    }
    await Plotly.relayout(gd,{
      'annotations': _annotationsBackup.filter((_,i)=>i!==_summaryIndex)
    });
    const filename=(document.getElementById('titleH1').innerText||'chart')
      .replace(/\s+/g,'_')+'_noSummary';
    await Plotly.downloadImage(gd,{format:'png',filename:filename});
    await Plotly.relayout(gd,{'annotations':_annotationsBackup});
  }catch(e){
    console.error(e);
    setStatus('Xu·∫•t PNG l·ªói: '+e.message,true);
  }
}

function isMobile(){
  const ua=navigator.userAgent || navigator.vendor || window.opera;
  return (/android/i.test(ua) || /iPad|iPhone|iPod/.test(ua) || (window.innerWidth<=768));
}
function applyMobileTweaks(){
  if(isMobile()){
    document.body.classList.add('is-mobile');
    const t2=document.querySelector('.toolbar2');
    if(t2) t2.style.display='none';
  }
}

/* Events */
document.getElementById('hotelSelect').addEventListener('change', ()=>{
  const p=PRESETS[document.getElementById('hotelSelect').value];
  document.getElementById('csvUrl').value=p.csv;
  document.getElementById('titleH1').innerText=p.title;
});
document.getElementById('renderBtn').addEventListener('click', render);
document.getElementById('toggleCSP').addEventListener('change', render);
document.getElementById('toggleADR').addEventListener('change', render);
document.getElementById('toggleREV').addEventListener('change', render);
document.getElementById('toggleGBLabel').addEventListener('change', render);
document.getElementById('modeSelect').addEventListener('change', render);
document.getElementById('exportBtn').addEventListener('click', exportPNG);

/* Init */
document.addEventListener('DOMContentLoaded', ()=>{
  const start=Date.now();
  (function waitPlotly(){
    if(window.Plotly){
      const p=PRESETS['TBH'];
      document.getElementById('hotelSelect').value='TBH';
      document.getElementById('csvUrl').value=p.csv;
      document.getElementById('titleH1').innerText=p.title;
      const today=new Date();
      const yyyy=today.getFullYear();
      const mm=('0'+(today.getMonth()+1)).slice(-2);
      const dd=('0'+today.getDate()).slice(-2);
      document.getElementById('meetingDate').value = yyyy+'-'+mm+'-'+dd;
      applyMobileTweaks();
      render();
    }else{
      if(Date.now()-start>8000){
        setStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c Plotly t·ª´ CDN. Vui l√≤ng ki·ªÉm tra m·∫°ng.',true);
        const pr=document.getElementById('preloader'); if(pr) pr.style.display='none';
        return;
      }
      setTimeout(waitPlotly,120);
    }
  })();
});

/* Resize */
window.addEventListener('resize', ()=>{
  if(document.getElementById('chart')) Plotly.Plots.resize('chart');
});
window.addEventListener('orientationchange', ()=>{
  setTimeout(()=>{
    if(document.getElementById('chart')) Plotly.Plots.resize('chart');
  },250);
});
</script>
</body>
</html>
