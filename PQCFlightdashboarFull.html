<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chuyến Bay Đến Phú Quốc</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .custom-legend {
      font-size: 8px !important;
    }
    .custom-tooltip {
      font-size: 8px !important;
    }
    .pie-table {
      font-size: 13px !important;
    }
    .animate-row {
      animation: fadeInUp 0.6s ease-out forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    .animate-row:nth-child(1) { animation-delay: 0.1s; }
    .animate-row:nth-child(2) { animation-delay: 0.2s; }
    .animate-row:nth-child(3) { animation-delay: 0.3s; }
    .animate-row:nth-child(4) { animation-delay: 0.4s; }
    .animate-row:nth-child(5) { animation-delay: 0.5s; }
    .animate-row:nth-child(6) { animation-delay: 0.6s; }
    .animate-row:nth-child(7) { animation-delay: 0.7s; }
    .animate-row:nth-child(8) { animation-delay: 0.8s; }
    .animate-row:nth-child(9) { animation-delay: 0.9s; }
    .animate-row:nth-child(10) { animation-delay: 1s; }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .table-container {
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div id="root" class="container mx-auto p-4"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { PieChart, Pie, Tooltip, Legend, Cell, ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Label } = Recharts;

    const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#A28EFF', '#FF4D4F', '#4CAF50', '#FF6F61', '#6B7280', '#AB47BC', '#F97316', '#10B981'];

    const parseDate = (dateStr) => {
      return new Date(dateStr);
    };

    const parseTimeToFraction = (timeStr) => {
      if (!timeStr || timeStr === 'Không xác định') return 0;
      const [hours, minutes] = timeStr.split(':').map(Number);
      return (hours + minutes / 60) / 24;
    };

    const fractionToTime = (fraction) => {
      if (isNaN(fraction)) return 'Không xác định';
      const hours = Math.floor(fraction * 24);
      const minutes = Math.round((fraction * 24 - hours) * 60);
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    };

    const normalizeCityName = (city) => {
      if (city === 'Danang') return 'Da Nang';
      return city.trim();
    };

    const cleanCountryName = (countryStr) => {
      if (!countryStr) return 'Không xác định';
      const parts = countryStr.split('|');
      if (parts.length > 1) {
        return parts[1].trim();
      }
      return countryStr.trim();
    };

    const processAndCleanData = (data) => {
      return data
        .filter(row => row['STT'] && row['Ngày'] && row['Thành phố'] && row['Quốc gia'])
        .map(row => ({
          stt: parseInt(row['STT']) || 0,
          date: parseDate(row['Ngày']),
          airline: row['Hãng bay'] ? row['Hãng bay'].trim() : 'Không xác định',
          city: normalizeCityName(row['Thành phố'] || 'Không xác định'),
          country: cleanCountryName(row['Quốc gia']),
          time: fractionToTime(parseTimeToFraction(row['TIME'])),
          flightNo: row['Flight No'] ? row['Flight No'].trim().replace(/^"|"$/g, '') : 'N/A',
          isDomestic: row['Domestic'] === 'X',
          isInternational: row['International'] === 'X'
        }));
    };

    const aggregateData = (data, groupBy, startDate = null, endDate = null) => {
      const counts = {};
      data.forEach(row => {
        const rowDate = row.date;
        if (startDate && endDate) {
          if (rowDate < startDate || rowDate > endDate) return;
        }
        const key = row[groupBy];
        counts[key] = (counts[key] || 0) + 1;
      });

      const sorted = Object.entries(counts)
        .sort((a, b) => b[1] - a[1]);
      return sorted.map(([name, value], index) => ({ name, value, stt: index + 1 }));
    };

    const aggregateDomesticInternational = (data, startDate = null, endDate = null) => {
      let domestic = 0, international = 0;
      data.forEach(row => {
        const rowDate = row.date;
        if (startDate && endDate) {
          if (rowDate < startDate || rowDate > endDate) return;
        }
        if (row.isDomestic) domestic++;
        if (row.isInternational) international++;
      });
      return [
        { name: 'Nội địa', value: domestic, stt: 1 },
        { name: 'Quốc tế', value: international, stt: 2 }
      ].filter(item => item.value > 0);
    };

    const getTopInternationalCityAndCountry = (data, startDate = null, endDate = null) => {
      const cityCounts = {};
      const countryCounts = {};
      const cityToCountry = {};

      data.forEach(row => {
        const rowDate = row.date;
        if (startDate && endDate) {
          if (rowDate < startDate || rowDate > endDate) return;
        }
        if (row.isInternational) {
          const city = row.city;
          const country = row.country;
          cityCounts[city] = (cityCounts[city] || 0) + 1;
          countryCounts[country] = (countryCounts[country] || 0) + 1;
          cityToCountry[city] = country;
        }
      });

      const topCountryEntry = Object.entries(countryCounts).sort((a, b) => b[1] - a[1])[0];
      const topCities = Object.entries(cityCounts)
        .filter(([city]) => cityToCountry[city] === topCountryEntry?.[0])
        .sort((a, b) => b[1] - a[1])
        .map(([name, count]) => ({ name, count }));

      const topCityEntry = Object.entries(cityCounts).sort((a, b) => b[1] - a[1])[0];
      const topCity = topCityEntry ? { name: topCityEntry[0], count: topCityEntry[1], country: cityToCountry[topCityEntry[0]] } : null;

      return {
        topCity,
        topCountry: topCountryEntry ? { name: topCountryEntry[0], count: topCountryEntry[1], cities: topCities } : null
      };
    };

    const aggregateCisCountries = (data, startDate = null, endDate = null) => {
      const cisCountryNames = ['Russia', 'Russian Federation', 'Nga', 'Belarus', 'Kazakhstan', 'Uzbekistan'];
      const results = [];
      cisCountryNames.forEach((countryName, index) => {
        const filtered = data.filter(row => row.country === countryName && row.isInternational && row.date >= (startDate || new Date(0)) && row.date <= (endDate || new Date()));
        const cityCounts = {};
        filtered.forEach(row => {
          cityCounts[row.city] = (cityCounts[row.city] || 0) + 1;
        });
        const total = filtered.length;
        const cities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).map(([name, count]) => ({ name, count }));
        if (total > 0) {
          results.push({
            name: countryName,
            value: total,
            stt: index + 1,
            cities: cities
          });
        }
      });
      // Sort by value descending
      results.sort((a, b) => b.value - a.value);
      // Reassign STT
      results.forEach((item, index) => { item.stt = index + 1; });
      return results;
    };

    const getCurrentMonthSheetName = (date) => {
      const monthNames = ['Tháng 01', 'Tháng 02', 'Tháng 03', 'Tháng 04', 'Tháng 05', 'Tháng 06',
                          'Tháng 07', 'Tháng 08', 'Tháng 09', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
      return monthNames[date.getMonth()] + ' ' + date.getFullYear();
    };

    const aggregateFlightsByDate = (data, startDate, endDate) => {
      const counts = {};
      const domesticCounts = {};
      const internationalCounts = {};
      data.forEach(row => {
        const rowDate = row.date.toISOString().split('T')[0];
        if (row.date >= startDate && row.date <= endDate) {
          counts[rowDate] = (counts[rowDate] || 0) + 1;
          if (row.isDomestic) domesticCounts[rowDate] = (domesticCounts[rowDate] || 0) + 1;
          if (row.isInternational) internationalCounts[rowDate] = (internationalCounts[rowDate] || 0) + 1;
        }
      });
      return Object.keys(counts).map(date => ({
        date: date,
        totalFlights: counts[date],
        domesticFlights: domesticCounts[date] || 0,
        internationalFlights: internationalCounts[date] || 0
      }));
    };

    const App = () => {
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [sheetUrl, setSheetUrl] = useState('https://docs.google.com/spreadsheets/d/e/2PACX-1vSCxWcOum9YRkT2GVTri0K13drPhagUXCJd93mWGIiZvoXnn9gvvMv-o-KLu3bvFZGYSsegG4p7DKPs/pub?gid=0&single=true&output=csv');
      const [startDate, setStartDate] = useState(new Date(2025, 9, 15));
      const [endDate, setEndDate] = useState(new Date(2025, 9, 15));
      const [language, setLanguage] = useState('vi');
      const [showAllCis, setShowAllCis] = useState(false);

      const translations = {
        vi: {
          title: 'Chuyến Bay Đến Phú Quốc - ',
          overviewTitle: 'TỔNG QUAN',
          cisTitle: 'Chuyến bay Charter CIS đến Phú Quốc',
          cisDetailTitle: 'Danh sách chi tiết Chuyến bay Charter CIS đến Phú Quốc',
          cisTotal: 'Tổng số chuyến bay: {total}',
          more: 'Nhiều hơn',
          flightNoHeader: 'Số hiệu chuyến bay',
          noData: 'Không có chuyến bay CIS trong khoảng thời gian này.',
          dateRange: 'Từ {start} đến {end}',
          category1: 'Tổng số chuyến bay đến Phú Quốc',
          detail1: '{total} chuyến',
          avg1: '{avg} chuyến/ngày',
          category2: 'Hãng bay đến Phú Quốc nhiều nhất là',
          detail2: '{airline}, {count} chuyến',
          avg2: '{avg} chuyến/ngày',
          category3: 'Thành phố thuộc VN bay đến Phú Quốc nhiều nhất là',
          detail3: '{city}, {count} chuyến',
          avg3: '{avg} chuyến/ngày',
          category4: 'Thành phố quốc tế bay đến Phú Quốc nhiều nhất là',
          detail4: '{city}, {count} chuyến thuộc Quốc gia {country}',
          avg4: '{avg} chuyến/ngày',
          category5: 'Quốc gia bay đến Phú Quốc nhiều nhất là',
          avg5: '{avg} chuyến/ngày',
          categoryHeader: 'Hạng mục',
          detailHeader: 'Thông tin chi tiết',
          avgHeader: 'Bình quân/ngày',
          sttHeader: 'STT',
          countryHeader: 'Quốc gia',
          dateHeader: 'Ngày',
          airlineHeader: 'Hãng bay',
          cityHeader: 'Thành phố',
          timeHeader: 'Thời gian',
          pie1: '1. Nội địa vs Quốc tế',
          pie2: '2. Chuyến bay theo Quốc gia',
          pie3: '3. Chuyến bay theo Hãng bay',
          pie4: '4. Chuyến bay theo Thành phố',
          list: 'Danh sách:',
          stt: 'STT',
          name: 'Tên',
          flights: 'Số chuyến',
          percentage: 'Tỷ lệ (%)',
          reload: 'Tải lại dữ liệu',
          urlPlaceholder: 'Nhập URL Google Sheets (CSV export)',
          loading: 'Đang tải dữ liệu chuyến bay...',
          fromDate: 'Từ ngày',
          toDate: 'Đến ngày',
          timeline: 'Biểu đồ thời gian số chuyến bay'
        },
        en: {
          title: 'Flight Dashboard - ',
          overviewTitle: 'OVERVIEW',
          cisTitle: 'CIS Charter Flights to Phu Quoc',
          cisDetailTitle: 'Detailed List of CIS Charter Flights to Phu Quoc',
          cisTotal: 'Total flights: {total}',
          more: 'More',
          flightNoHeader: 'Flight No',
          noData: 'No CIS flights in this time period.',
          dateRange: 'From {start} to {end}',
          category1: 'Total flights to Phu Quoc',
          detail1: '{total} flights',
          avg1: '{avg} flights/day',
          category2: 'Top airline to Phu Quoc',
          detail2: '{airline}, {count} flights',
          avg2: '{avg} flights/day',
          category3: 'Top VN city to Phu Quoc',
          detail3: '{city}, {count} flights',
          avg3: '{avg} flights/day',
          category4: 'Top international city to Phu Quoc',
          detail4: '{city}, {count} flights from {country}',
          avg4: '{avg} flights/day',
          category5: 'Top country to Phu Quoc',
          avg5: '{avg} flights/day',
          categoryHeader: 'Category',
          detailHeader: 'Details',
          avgHeader: 'Average/day',
          sttHeader: 'No.',
          countryHeader: 'Country',
          dateHeader: 'Date',
          airlineHeader: 'Airline',
          cityHeader: 'City',
          timeHeader: 'Time',
          pie1: '1. Domestic vs International',
          pie2: '2. Flights by Country',
          pie3: '3. Flights by Airline',
          pie4: '4. Flights by City',
          list: 'List:',
          stt: 'No.',
          name: 'Name',
          flights: 'Flights',
          percentage: 'Percentage (%)',
          reload: 'Reload Data',
          urlPlaceholder: 'Enter Google Sheets URL (CSV export)',
          loading: 'Loading flight data...',
          fromDate: 'From Date',
          toDate: 'To Date',
          timeline: 'Timeline of Flights'
        }
      };

      const t = (key, vars = {}) => {
        let translation = translations[language][key] || key;
        Object.keys(vars).forEach(varName => {
          translation = translation.replace(new RegExp(`{${varName}}`, 'g'), vars[varName]);
        });
        return translation;
      };

      const loadData = (url) => {
        setLoading(true);
        fetch(`${url}`)
          .then(response => {
            if (!response.ok) throw new Error('Không thể tải dữ liệu từ URL');
            return response.text();
          })
          .then(csvText => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              transformHeader: header => header.trim().replace(/^"|"$/g, ''),
              transform: value => value.trim().replace(/^"|"$/g, ''),
              complete: (results) => {
                const cleanedData = processAndCleanData(results.data);
                console.log('Dữ liệu đã load:', cleanedData.length);
                setData(cleanedData);
                setLoading(false);
              },
              error: (err) => {
                console.error('Lỗi khi phân tích CSV:', err);
                setLoading(false);
                alert('Lỗi khi tải dữ liệu CSV. Vui lòng kiểm tra URL hoặc định dạng file.');
              }
            });
          })
          .catch(err => {
            console.error('Lỗi khi tải dữ liệu:', err);
            setLoading(false);
            alert('Lỗi khi tải dữ liệu từ Google Sheets. Vui lòng kiểm tra URL.');
          });
      };

      useEffect(() => {
        if (sheetUrl) {
          loadData(sheetUrl);
        }
      }, [sheetUrl]);

      const handleReload = () => {
        if (sheetUrl) {
          loadData(sheetUrl);
        } else {
          alert('Vui lòng nhập URL Google Sheets hợp lệ!');
        }
      };

      const handleUrlChange = (e) => {
        setSheetUrl(e.target.value);
      };

      const getFilteredData = () => {
        const filtered = data.filter(row => {
          const rowDate = row.date;
          return rowDate >= startDate && rowDate <= endDate;
        });
        return filtered;
      };

      const getCisFlights = () => {
        const cisCountries = ['Russia', 'Russian Federation', 'Nga', 'Belarus', 'Kazakhstan', 'Uzbekistan'];
        return getFilteredData()
          .filter(row => row.isInternational && cisCountries.includes(row.country))
          .sort((a, b) => b.date.getTime() - a.date.getTime() || parseTimeToFraction(b.time) - parseTimeToFraction(a.time));
      };

      const getDetailText = (type, values) => {
        const { count, country } = values;
        const unit = language === 'vi' ? 'chuyến' : 'flights';
        if (type === 'airline' || type === 'domesticCity') {
          return `, ${count} ${unit}`;
        } else if (type === 'intlCity') {
          return language === 'vi' ? `, ${count} ${unit} thuộc Quốc gia ${country}` : `, ${count} ${unit} from ${country}`;
        }
        return '';
      };

      const getCisDetailText = (item) => {
        const unit = language === 'vi' ? 'chuyến' : 'flights';
        return language === 'vi' ? `${item.value} ${unit}. Bay từ:` : `${item.value} ${unit}. From:`;
      };

      const renderAnimatedTable = (rows, headers) => {
        return (
          <div className="table-container">
            <table className="w-full text-left border-collapse border border-gray-300 text-sm">
              <thead>
                <tr className="bg-gray-200">
                  {headers.map((header, idx) => (
                    <th key={idx} className="border border-gray-300 p-2">{header}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {rows.map((row, index) => (
                  <tr key={index} className="animate-row border-t border-gray-300">
                    {row.map((cell, cellIdx) => (
                      <td key={cellIdx} className="border border-gray-300 p-2">{cell}</td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      };

      const renderPieChart = (data, title, key) => {
        const total = data.reduce((sum, item) => sum + item.value, 0);
        const formattedTitle = title.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
        const showLegend = !['airline', 'city'].includes(key);
        return (
          <div className="bg-white p-4 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold text-center mb-4">{formattedTitle}</h3>
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={data}
                  dataKey="value"
                  nameKey="name"
                  cx="50%"
                  cy="50%"
                  outerRadius={100}
                  fill="#8884d8"
                  label
                >
                  {data.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip className="custom-tooltip" />
                {showLegend && <Legend className="custom-legend" />}
              </PieChart>
            </ResponsiveContainer>
            <div className="mt-4">
              <h4 className="text-md font-semibold mb-2">{t('list')}</h4>
              <table className="w-full text-left border-collapse border border-gray-300 pie-table">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border border-gray-300 p-1">{t('stt')}</th>
                    <th className="border border-gray-300 p-1">{t('name')}</th>
                    <th className="border border-gray-300 p-1">{t('flights')}</th>
                    <th className="border border-gray-300 p-1">{t('percentage')}</th>
                  </tr>
                </thead>
                <tbody>
                  {data.map((item, index) => (
                    <tr key={`cell-${index}`} className="border-t border-gray-300">
                      <td className="border border-gray-300 p-1">{item.stt}</td>
                      <td className="border border-gray-300 p-1">{item.name}</td>
                      <td className="border border-gray-300 p-1">{item.value}</td>
                      <td className="border border-gray-300 p-1">{((item.value / total) * 100).toFixed(2)}%</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {key === 'domesticInternational' && (
                <div className="mt-4">
                  {renderLineChart(aggregateFlightsByDate(getFilteredData(), startDate, endDate), t('timeline'))}
                </div>
              )}
            </div>
          </div>
        );
      };

      const renderLineChart = (data, title) => {
        const formattedTitle = title.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
        return (
          <div className="bg-white p-4 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold text-center mb-4">{formattedTitle}</h3>
            <ResponsiveContainer width="100%" height={200}>
              <LineChart data={data}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="date" 
                  type="category" 
                  allowDuplicatedCategory={false}
                />
                <YAxis>
                  <Label angle={270} position="left" style={{ textAnchor: 'middle' }} value="Số chuyến bay" />
                </YAxis>
                <Tooltip />
                <Legend className="custom-legend" />
                <Line type="monotone" dataKey="totalFlights" stroke="#8884d8" name="Tổng số chuyến" />
                <Line type="monotone" dataKey="domesticFlights" stroke="#00C49F" name="Nội địa" />
                <Line type="monotone" dataKey="internationalFlights" stroke="#FFBB28" name="Quốc tế" />
              </LineChart>
            </ResponsiveContainer>
            <p className="text-sm text-gray-600 mt-2">Biểu đồ hiển thị số lượng chuyến bay theo ngày trong khoảng thời gian đã chọn.</p>
          </div>
        );
      };

      if (loading) {
        return <div className="text-center text-xl">{t('loading')}</div>;
      }

      const filteredData = getFilteredData();
      const totalFlights = filteredData.length;
      const numDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const showAvg = numDays > 1;
      const avgTotal = showAvg ? Math.round(totalFlights / numDays) : '';

      const domesticInternational = aggregateDomesticInternational(filteredData, startDate, endDate);
      const byCountry = aggregateData(filteredData, 'country', startDate, endDate);
      const byAirline = aggregateData(filteredData, 'airline', startDate, endDate);
      const byCity = aggregateData(filteredData, 'city', startDate, endDate);
      const { topCity, topCountry: topCountryData } = getTopInternationalCityAndCountry(filteredData, startDate, endDate);
      const cisData = aggregateCisCountries(filteredData, startDate, endDate);
      const cisFlights = getCisFlights();

      const topAirline = byAirline.length > 0 ? byAirline[0].name : 'Không xác định';
      const topAirlineFlights = byAirline.length > 0 ? byAirline[0].value : 0;
      const avgTopAirline = showAvg ? Math.round(topAirlineFlights / numDays) : '';

      const topDomesticData = aggregateData(filteredData.filter(r => r.isDomestic), 'city', startDate, endDate);

      const topIntlCity = topCity ? topCity.name : 'Không xác định';
      const topIntlCityCountry = topCity ? topCity.country : 'Không xác định';
      const topIntlCityFlights = topCity ? topCity.count : 0;
      const avgTopIntlCity = showAvg ? Math.round(topIntlCityFlights / numDays) : '';

      const topCountryName = topCountryData ? topCountryData.name : 'Không xác định';
      const topCountryFlights = topCountryData ? topCountryData.count : 0;
      const avgTopCountry = showAvg ? Math.round(topCountryFlights / numDays) : '';

      const formatDate = (date) => {
        return `${date.getDate()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
      };

      const startDateFormatted = formatDate(startDate);
      const endDateFormatted = formatDate(endDate);

      const displayedCisFlights = showAllCis ? cisFlights : cisFlights.slice(0, 10);

      const generateDomesticRows = () => {
        const rows = [];
        let i = 0;
        let rank = 1;
        const separator = language === 'vi' ? ' và ' : ' and ';
        while (i < topDomesticData.length && rank <= 3) {
          const currentValue = topDomesticData[i].value;
          const group = [];
          while (i < topDomesticData.length && topDomesticData[i].value === currentValue) {
            group.push(topDomesticData[i]);
            i++;
          }
          if (group.length > 0) {
            const cityList = group.map(g => g.name).join(separator);
            const detail = (
              <>
                <strong>{cityList}</strong>
                {getDetailText('domesticCity', {count: currentValue})}
              </>
            );
            const avg = showAvg ? Math.round(currentValue / numDays) : '';
            rows.push(
              <tr key={`domestic-${rank}`}>
                <td className="border border-gray-300 p-2">TOP {rank} {t('category3')}</td>
                <td className="border border-gray-300 p-2">{detail}</td>
                <td className="border border-gray-300 p-2">{showAvg ? t('avg3', { avg: avg }) : ''}</td>
              </tr>
            );
            rank++;
          }
        }
        return rows;
      };

      const overviewHeaders = [t('categoryHeader'), t('detailHeader'), t('avgHeader')];
      const overviewRows = [
        [t('category1'), t('detail1', { total: totalFlights }), showAvg ? t('avg1', { avg: avgTotal }) : ''],
        [t('category2'), <><strong>{topAirline}</strong>{getDetailText('airline', {count: topAirlineFlights})}</>, showAvg ? t('avg2', { avg: avgTopAirline }) : ''],
        ...generateDomesticRows().map(row => {
          const cells = Array.from(row.props.children).map(child => child.props.children || child);
          return cells;
        }),
        [t('category4'), <><strong>{topIntlCity}</strong>{getDetailText('intlCity', {count: topIntlCityFlights, country: topIntlCityCountry})}</>, showAvg ? t('avg4', { avg: avgTopIntlCity }) : ''],
        [t('category5'), <><strong>{topCountryName}</strong>, {topCountryFlights} {language === 'vi' ? 'chuyến' : 'flights'}. {language === 'vi' ? 'Bay từ:' : 'From:'} {' '}
          {topCountryData && topCountryData.cities && topCountryData.cities.length > 0 ? (
            topCountryData.cities.map((city, idx) => (
              <span key={idx}>
                <strong>{city.name}</strong>, {city.count} {language === 'vi' ? 'chuyến' : 'flights'}{idx < topCountryData.cities.length - 1 ? '; ' : ''}
              </span>
            ))
          ) : (
            language === 'vi' ? 'Không có dữ liệu' : 'No data'
          )}</>, showAvg ? t('avg5', { avg: avgTopCountry }) : '']
      ].filter(row => row[0] !== undefined);

      const cisHeaders = [t('sttHeader'), t('countryHeader'), t('detailHeader'), t('avgHeader')];
      const cisRows = cisData.map(item => [
        item.stt,
        <strong>{item.name}</strong>,
        <>{getCisDetailText(item)}{' '}
          {item.cities && item.cities.length > 0 ? (
            item.cities.map((city, idx) => (
              <span key={idx}>
                <strong>{city.name}</strong>, {city.count} {language === 'vi' ? 'chuyến' : 'flights'}{idx < item.cities.length - 1 ? '; ' : ''}
              </span>
            ))
          ) : (
            language === 'vi' ? 'Không có dữ liệu' : 'No data'
          )}</>,
        showAvg ? t('avg1', { avg: Math.round(item.value / numDays) }) : ''
      ]);

      const cisDetailHeaders = [t('stt'), t('dateHeader'), t('airlineHeader'), t('cityHeader'), t('countryHeader'), t('timeHeader'), t('flightNoHeader')];
      const cisDetailRows = displayedCisFlights.map((row, index) => [
        index + 1,
        formatDate(row.date),
        <strong>{row.airline}</strong>,
        <strong>{row.city}</strong>,
        <strong>{row.country}</strong>,
        row.time,
        row.flightNo
      ]);

      return (
        <div className="space-y-8">
          <h1 className="text-3xl font-bold text-center text-blue-600 mb-4">{t('title')}{getCurrentMonthSheetName(startDate)}</h1>
          <div className="flex flex-wrap items-center justify-center space-x-4 space-y-2 bg-blue-600 text-white p-4 rounded-lg">
            <label className="whitespace-nowrap">{t('fromDate')}: </label>
            <input
              type="date"
              className="p-2 rounded text-black"
              value={startDate.toISOString().split('T')[0]}
              onChange={(e) => setStartDate(new Date(e.target.value))}
              min="2025-10-01"
              max="2025-12-31"
            />
            <label className="whitespace-nowrap">{t('toDate')}: </label>
            <input
              type="date"
              className="p-2 rounded text-black"
              value={endDate.toISOString().split('T')[0]}
              onChange={(e) => setEndDate(new Date(e.target.value))}
              min="2025-10-01"
              max="2025-12-31"
            />
            <input
              type="text"
              className="p-2 rounded text-black"
              value={sheetUrl}
              onChange={handleUrlChange}
              placeholder={t('urlPlaceholder')}
            />
            <button
              className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
              onClick={handleReload}
            >
              {t('reload')}
            </button>
            <button
              className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
              onClick={() => setLanguage(language === 'vi' ? 'en' : 'vi')}
            >
              {language === 'vi' ? 'Switch to English' : 'Chuyển sang Tiếng Việt'}
            </button>
          </div>

          <div className="bg-white p-4 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4">{t('overviewTitle')}</h2>
            <p className="mb-4 text-sm">{t('dateRange', { start: startDateFormatted, end: endDateFormatted })}</p>
            {renderAnimatedTable(overviewRows, overviewHeaders)}

            <h3 className="text-lg font-semibold mb-2 mt-6">{t('cisTitle')}</h3>
            <p className="mb-2 text-sm font-semibold">{t('cisTotal', { total: cisFlights.length })}</p>
            {renderAnimatedTable(cisRows, cisHeaders)}

            <h3 className="text-lg font-semibold mb-2 mt-6">{t('cisDetailTitle')}</h3>
            {cisFlights.length > 0 ? (
              <>
                {renderAnimatedTable(cisDetailRows, cisDetailHeaders)}
                {cisFlights.length > 10 && !showAllCis && (
                  <button
                    className="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm"
                    onClick={() => setShowAllCis(true)}
                  >
                    {t('more')}
                  </button>
                )}
                {showAllCis && (
                  <button
                    className="mt-2 bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded text-sm"
                    onClick={() => setShowAllCis(false)}
                  >
                    {language === 'vi' ? 'Thu gọn' : 'Less'}
                  </button>
                )}
              </>
            ) : (
              <p className="text-sm text-gray-600">{t('noData')}</p>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {renderPieChart(domesticInternational, t('pie1'), 'domesticInternational')}
            {renderPieChart(byCountry, t('pie2'), 'country')}
            {renderPieChart(byAirline, t('pie3'), 'airline')}
            {renderPieChart(byCity, t('pie4'), 'city')}
          </div>

          <footer className="text-center text-xs text-gray-500 mt-8 pt-4">
            <strong>Written by Mr Ái Trì @2025. Mob.: 0903 049955</strong>
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>