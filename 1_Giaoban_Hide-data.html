<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Giao ban Tahiti ‚Äì v12c6</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root{ 
  --avg:#D95F02;    /* ƒê∆∞·ªùng TB */
  --week:#E9F4FF;   /* N·ªÅn tu·∫ßn h·ªçp */
  --wed:#FF8C00;    /* V·∫°ch giao ban */
  --occ:#0a84ff;    /* C√¥ng su·∫•t */
  --adr:#2ca02c;    /* ADR */
  --rev:#0a84ff;    /* Revenue bar */
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:16px;color:#111;background:#fff}
h1{margin:0 0 6px 0;font-size:22px;font-weight:800;text-align:center}
h2{margin:0 0 12px 0;font-size:16px;font-weight:600;text-align:center;color:#333}
.toolbar,.toolbar2,.toolbar3{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center;margin:10px 0 12px}
.toolbar select,.toolbar input[type="text"],.toolbar input[type="date"],.toolbar2 input[type="text"]{padding:6px 8px;border:1px solid #ccc;border-radius:6px;min-width:220px}
.toolbar button{padding:8px 12px;border:0;border-radius:8px;background:#111;color:#fff;cursor:pointer}
#chart{width:100%;height:72vh}
#status{margin:10px auto;max-width:1200px;font-size:12px;color:#333;background:#f7f7f7;border:1px solid #e5e5e5;border-radius:8px;padding:10px;white-space:pre-wrap}
label{font-size:12px;color:#333}
.gb-label{color:var(--wed); font-size:11px; font-weight:700;}
.error{color:#b00020;font-weight:bold}
</style>
</head>
<body>
<h1 id="titleH1">TAHITI BEACH HOTEL</h1>
<h2 id="titleH2">Briefing view ‚Äì Tu·∫ßn tr∆∞·ªõc, tu·∫ßn n√†y v√† 2 tu·∫ßn k·∫ø ti·∫øp</h2>

<div class="toolbar">
  <label>C∆° s·ªü:</label>
  <select id="hotelSelect">
    <option value="TBH">Tahiti Beach Hotel</option>
    <option value="TR">Tahiti Resort</option>
    <option value="TC">Tahiti Central</option>
    <option value="HTR">H·ªìng Tuy·∫øt Riverside</option>
  </select>
  <label>Ch·∫ø ƒë·ªô hi·ªÉn th·ªã:</label>
  <select id="modeSelect">
    <option value="BRIEFING" selected>Briefing view</option>
    <option value="MONTHLY">Monthly view</option>
  </select>
  <label>M·ª•c ng√†y ch·ªçn:</label>
  <input id="meetingDate" type="date" />
  <button id="renderBtn">V·∫Ω l·∫°i</button>
  <button id="exportBtn">üñºÔ∏è T·∫£i PNG (·∫©n summary)</button>
</div>

<div class="toolbar2">
  <label>Google Sheets CSV (t√πy ch·ªânh):</label>
  <input id="csvUrl" type="text" placeholder="(Tu·ª≥ ch·ªçn) D√°n link CSV kh√°c n·∫øu mu·ªën‚Ä¶">
</div>

<div class="toolbar3">
  <label><input id="toggleADR" type="checkbox"> Hi·ªÉn th·ªã ADR</label>
  <label><input id="toggleREV" type="checkbox"> Hi·ªÉn th·ªã Room Revenue</label>
</div>

<div id="chart"></div>
<div id="status">v12c6: Th√™m n√∫t xu·∫•t PNG (·∫©n summary) + Ti√™u ƒë·ªÅ g√≥c tr√°i ƒë·ªïi theo Briefing/Monthly.</div>

<script>
const PRESETS = {
  "TBH": {
    title: "TAHITI BEACH HOTEL",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=1366109607&single=true&output=csv"
  },
  "TR": {
    title: "TAHITI RESORT",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=1949035251&single=true&output=csv"
  },
  "TC": {
    title: "TAHITI CENTRAL",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=742745253&single=true&output=csv"
  },
  "HTR": {
    title: "H·ªíNG TUY·∫æT RIVERSIDE",
    csv: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTrCaHX73UYmyHKeuwGb76mGq-JOtPM4MC75DC09zUUPqXXKw1uiDa0cVgDu8zi3w/pub?gid=626348031&single=true&output=csv"
  }
};

function setStatus(msg, isError){ const el=document.getElementById('status'); el.innerHTML=(isError?'<span class="error">L·ªñI: </span>':'')+msg; }
function splitLines(text){ return text.replace(/\r/g,'').split('\n'); }
function parseCSV(text){
  const lines = splitLines(text).filter(Boolean);
  const headers = lines[0].split(',').map(s=>s.trim());
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(',');
    const row = {};
    for(let j=0;j<headers.length;j++){ row[headers[j]] = (cols[j]||'').trim(); }
    rows.push(row);
  }
  return {headers, rows};
}
function parseDate(s){
  if(!s) return null;
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){ const dd=parseInt(s.slice(0,2),10), mm=parseInt(s.slice(3,5),10), yy=parseInt(s.slice(6,10),10); return new Date(yy,mm-1,dd); }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){ const yy=parseInt(s.slice(0,4),10), mm=parseInt(s.slice(5,7),10), dd=parseInt(s.slice(8,10),10); return new Date(yy,mm-1,dd); }
  const d=new Date(s); return isNaN(d.getTime())?null:d;
}
function numPercent(v){ if(v==null) return null; let s=String(v).replace(/[^0-9.-]/g,''); let n=parseFloat(s); return isNaN(n)?null:n; }
function numMoney(v){ if(v==null) return null; let s=String(v).replace(/[^0-9-]/g,''); if(!s) return null; return parseInt(s,10); }
function fmtDDMM(d){ const dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2); return dd+'/'+mm; }
function fmtDDMMYYYY(d){ const dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear(); return dd+'/'+mm+'/'+yy; }
function fmtMonthYYYY(d){ const mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear(); return mm+'/'+yy; }
function fmtMil(n){ if(n==null||isNaN(n)) return ''; return (n/1e6).toFixed(1).replace(/\.0$/,'') + 'M'; }
function viMoney(n){ try{return Number(n||0).toLocaleString('vi-VN');}catch(e){return n;} }
function getKey(headers, target){ const norm=s=>s.toLowerCase().replace(/\s+/g,' ').trim(); const want=norm(target); for(const h of headers){ if(norm(h)===want) return h; } return null; }
function decideMode(a,b){ if(a&&b) return 'ADR_REV'; if(a&&!b) return 'ADR_ONLY'; if(!a&&b) return 'REV_ONLY'; return 'OCC_ONLY'; }
function lastWednesday(date){ const d=new Date(date.getFullYear(),date.getMonth(),date.getDate()); const day=d.getDay(); const diff=(day>=3)?day-3:day+4; d.setDate(d.getDate()-diff); return d; }
function makeWindows(viewMode, pickStr){
  const day=24*3600*1000;
  if(viewMode==='MONTHLY' && pickStr){
    const d=parseDate(pickStr); if(!d) return null;
    if(d.getDate()===1){ const end=new Date(d.getFullYear(),d.getMonth()+1,0); return {start:d,end:end,title:'Monthly view ('+fmtDDMM(d)+' ‚Üí '+fmtDDMM(end)+')',monthly:true, monthText:fmtMonthYYYY(d)}; }
    else{ const end=new Date(d.getTime()+30*day); return {start:d,end:end,title:'Monthly view ('+fmtDDMM(d)+' ‚Üí '+fmtDDMM(end)+')',monthly:true, monthText:fmtMonthYYYY(d)}; }
  }else{
    let meeting = pickStr ? parseDate(pickStr) : lastWednesday(new Date());
    if(!meeting) meeting = lastWednesday(new Date());
    return {start:new Date(meeting.getTime()-7*day), end:new Date(meeting.getTime()+21*day), title:'Briefing view ‚Äì Tu·∫ßn tr∆∞·ªõc, tu·∫ßn n√†y v√† 2 tu·∫ßn k·∫ø ti·∫øp', monthly:false, meeting};
  }
}

let _annotationsBackup=null, _summaryIndex=null;

async function render(){
  try{
    const sel=document.getElementById('hotelSelect').value;
    const preset=PRESETS[sel];
    document.getElementById('titleH1').innerText=preset.title;
    const csvInput=document.getElementById('csvUrl');
    if(!csvInput.value){ csvInput.value=preset.csv; }
    const csvUrl=csvInput.value.trim();

    const viewMode=document.getElementById('modeSelect').value;
    const pickStr=document.getElementById('meetingDate').value;
    const showADR=document.getElementById('toggleADR').checked;
    const showREV=document.getElementById('toggleREV').checked;
    const dispMode=decideMode(showADR,showREV);

    setStatus('ƒêang t·∫£i CSV‚Ä¶\n'+csvUrl);
    const res = await fetch(csvUrl, {cache:'no-store'});
    if(!res.ok) throw new Error('Kh√¥ng t·∫£i ƒë∆∞·ª£c CSV. HTTP '+res.status);
    const raw=await res.text();
    const parsed=parseCSV(raw);
    const headers=parsed.headers, rows=parsed.rows;

    const kDate=getKey(headers,'Date'); const kOccRooms=getKey(headers,'Occupied'); const kOccPct=getKey(headers,'Occupancy'); const kRev=getKey(headers,'Room Revenue'); const kADR=getKey(headers,'ADR');
    if(!kDate||!kOccRooms||!kOccPct) throw new Error('Thi·∫øu c·ªôt b·∫Øt bu·ªôc: Date, Occupied, Occupancy.\nHeaders: '+headers.join(' | '));

    const arr=[];
    for(const r of rows){
      const d=parseDate(r[kDate]); if(!d) continue;
      let occ=numPercent(r[kOccPct]); if(occ<=1) occ*=100; occ=Math.round(occ);
      const occRooms=numMoney(r[kOccRooms]);
      const adr=kADR?numMoney(r[kADR]):null;
      const rev=kRev?numMoney(r[kRev]):null;
      arr.push({d,occ,occRooms,adr,rev});
    }
    if(arr.length===0) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá.');
    arr.sort((a,b)=>a.d-b.d);

    const win=makeWindows(viewMode, pickStr);
    if(!win) throw new Error('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c c·ª≠a s·ªï d·ªØ li·ªáu.');
    const data=arr.filter(o=>o.d>=win.start && o.d<=win.end);
    if(data.length===0) throw new Error('Kh√¥ng c√≥ d·ªØ li·ªáu trong c·ª≠a s·ªï ƒë√£ ch·ªçn.');

    const dates=data.map(o=>o.d), occ=data.map(o=>o.occ), rooms=data.map(o=>o.occRooms), adrVals=data.map(o=>o.adr), revVals=data.map(o=>o.rev);
    const hasAdrData=adrVals.some(v=>v!=null&&!isNaN(v)); const hasRevData=revVals.some(v=>v!=null&&!isNaN(v));

    const traces=[], shapes=[], annotations=[];
    document.getElementById('titleH2').innerText = win.title;

    if(dispMode==='OCC_ONLY'){
      const labels=occ.map((v,i)=> v!=null? (v+'%<br>('+(Math.round(rooms[i]||0))+'p)') : '');
      const textpos=occ.map(v=> v>90 ? 'bottom center':'top center');
      traces.push({x:dates,y:occ,type:'scatter',mode:'lines+markers+text',name:'C√¥ng su·∫•t ph√≤ng (%)',
        line:{width:2,color:getComputedStyle(document.documentElement).getPropertyValue('--occ').trim()},
        marker:{size:6,color:getComputedStyle(document.documentElement).getPropertyValue('--occ').trim()},
        text:labels,textposition:textpos,textfont:{size:11,family:'Arial'}});
    }
    if(dispMode==='ADR_ONLY' || dispMode==='ADR_REV'){
      if(hasAdrData){
        const cds=adrVals.map((v,i)=> v!=null ? ('<b>'+fmtDDMM(dates[i])+'</b><br>ADR: '+viMoney(v)+' VND') : '');
        traces.push({x:dates,y:adrVals,type:'scatter',mode:'lines+markers',name:'ADR (VND)',
          line:{width:2,color:getComputedStyle(document.documentElement).getPropertyValue('--adr').trim()},
          marker:{size:5,color:getComputedStyle(document.documentElement).getPropertyValue('--adr').trim()},
          hovertemplate:'%{customdata}<extra></extra>',customdata:cds,yaxis:'y'});
      }
    }
    if(dispMode==='REV_ONLY' || dispMode==='ADR_REV'){
      if(hasRevData){
        traces.push({x:dates,y:revVals,type:'bar',name:'Room Revenue (VND/ng√†y)',
          marker:{color:getComputedStyle(document.documentElement).getPropertyValue('--rev').trim()},opacity:0.95,
          text:revVals.map(v=> (v||v===0)?fmtMil(v):''), textposition:'outside', textfont:{size:12},
          yaxis:(dispMode==='ADR_REV'&&hasAdrData)?'y2':'y'});
      }
    }

    // ======= Annotations =======
    // Title top-left inside chart
    const hotelTitle = PRESETS[document.getElementById('hotelSelect').value].title;
    if(viewMode==='BRIEFING'){
      const line1 = '<span style="font-size:16px;font-weight:800;">'+hotelTitle+'</span>';
      const line2 = '<span style="font-size:12px;font-weight:600;">Briefing view ‚Äì t·ª´ '+fmtDDMMYYYY(win.start)+' ƒë·∫øn '+fmtDDMMYYYY(win.end)+'</span>';
      annotations.push({x:0,y:1.13,xref:'paper',yref:'paper',xanchor:'left',yanchor:'top',showarrow:false,text: line1+'<br>'+line2});
    }else{
      const line1 = '<span style="font-size:16px;font-weight:800;">'+hotelTitle+'</span>';
      const line2 = '<span style="font-size:12px;font-weight:600;">Monthly view ‚Äì Th√°ng '+win.monthText+'</span>';
      annotations.push({x:0,y:1.13,xref:'paper',yref:'paper',xanchor:'left',yanchor:'top',showarrow:false,text: line1+'<br>'+line2});
    }

    if(viewMode==='BRIEFING'){
      const day=24*3600*1000, meeting=win.meeting;
      shapes.push({type:'rect',xref:'x',yref:'paper',x0:meeting,x1:new Date(meeting.getTime()+7*day),y0:0,y1:1,fillcolor:getComputedStyle(document.documentElement).getPropertyValue('--week').trim(),opacity:0.35,line:{width:0}});
      const marks=[new Date(meeting.getTime()-7*day),meeting,new Date(meeting.getTime()+7*day),new Date(meeting.getTime()+14*day),new Date(meeting.getTime()+21*day)];
      for(const d of marks){ 
        shapes.push({type:'line',xref:'x',yref:'paper',x0:d,x1:d,y0:0,y1:1,line:{color:getComputedStyle(document.documentElement).getPropertyValue('--wed').trim(),width:1.5,dash:'dash'}}); 
        annotations.push({x:d,y:0,xref:'x',yref:'paper',showarrow:false,text:'<span class="gb-label">Giao ban</span>',textangle:-90,yshift:18});
      }
      if(dispMode==='OCC_ONLY'){
        const avgColor=getComputedStyle(document.documentElement).getPropertyValue('--avg').trim();
        function seg(s){ return {s:s,e:new Date(s.getTime()+7*day)}; }
        function avg(s,e){ let sum=0,n=0; for(let i=0;i<dates.length;i++){ if(dates[i]>=s && dates[i]<=e){ sum+=occ[i]; n++; }} return n?sum/n:null; }
        const segs=[seg(new Date(meeting.getTime()-7*day)),seg(meeting),seg(new Date(meeting.getTime()+7*day)),seg(new Date(meeting.getTime()+14*day))];
        for(const S of segs){ const a=avg(S.s,S.e); if(a==null) continue; const xs=S.s<dates[0]?dates[0]:S.s, xe=S.e>dates[dates.length-1]?dates[dates.length-1]:S.e;
          shapes.push({type:'line',xref:'x',yref:'y',x0:xs,x1:xe,y0:a,y1:a,line:{color:avgColor,width:2}});
          annotations.push({x:xe,y:a,xref:'x',yref:'y',axref:'x',ayref:'y',ax:xs,ay:a,showarrow:true,arrowside:'end+start',arrowhead:3,startarrowhead:3,arrowwidth:1.6,arrowcolor:avgColor,text:''});
          annotations.push({x:xs,y:a,xref:'x',yref:'y',showarrow:false,text:'<span style="color:'+avgColor+';font-weight:800;font-family:Arial Black;">TB: '+Math.round(a)+'%</span>',
            xanchor:'left',yanchor:'bottom',xshift:6});
        }
      }
    }

    // Summary (right-top)
    const avgOcc=Math.round(occ.reduce((a,b)=>a+(b||0),0)/occ.filter(v=>v!=null).length);
    const avgADR=hasAdrData?Math.round(adrVals.reduce((a,b)=>a+(b||0),0)/adrVals.filter(v=>v!=null).length):null;
    const sumRev=hasRevData?revVals.reduce((a,b)=>a+(b||0),0):null;
    const summaryHTML='<span style="color:#111;font-weight:700;">B√¨nh qu√¢n CSP: '+(isFinite(avgOcc)?avgOcc:0)+'%</span>'
      +' &nbsp; | &nbsp; <span style="color:#2ca02c;font-weight:700;">B√¨nh qu√¢n ADR: '+(avgADR!=null?viMoney(avgADR):'‚Äî')+' VND</span>'
      +' &nbsp; | &nbsp; <span style="color:#0057D9;font-weight:800;">T·ªïng DT d·ª± ki·∫øn: '+(sumRev!=null?viMoney(sumRev):'‚Äî')+' VND</span>';
    annotations.push({x:1,y:1.13,xref:'paper',yref:'paper',xanchor:'right',yanchor:'top',text:summaryHTML,showarrow:false,
      font:{size:13,family:'Arial'},bgcolor:'rgba(255,255,255,0.9)',borderpad:2});
    _summaryIndex = annotations.length - 1;

    const layout={margin:{l:70,r:70,t:90,b:60},
      xaxis:{tickmode:'array',tickvals:dates,ticktext:dates.map(fmtDDMM),tickangle:-45,showgrid:true,gridcolor:'rgba(0,0,0,0.15)'},
      yaxis:{title:(dispMode==='OCC_ONLY'?'C√¥ng su·∫•t ph√≤ng (%)':(dispMode==='ADR_ONLY'?'ADR (VND)':(dispMode==='REV_ONLY'?'Room Revenue (VND/ng√†y)':'ADR (VND)'))),rangemode:'tozero',showgrid:true,gridcolor:'rgba(0,0,0,0.15)'},
      shapes:win.monthly?[]:shapes,annotations:annotations,showlegend:true,legend:{x:1,y:1,xanchor:'right',yanchor:'top',bgcolor:'rgba(255,255,255,0.85)'}};
    if(dispMode==='ADR_REV'&&hasAdrData&&hasRevData){ layout.yaxis2={title:'Room Revenue (VND/ng√†y)',overlaying:'y',side:'right',rangemode:'tozero'}; }

    Plotly.newPlot('chart', traces, layout, {responsive:true, displaylogo:false});

    _annotationsBackup = annotations.map(a => Object.assign({}, a));

    setStatus('CSV OK. '+win.title+'\nC·ª≠a s·ªï: '+fmtDDMM(win.start)+' ‚Üí '+fmtDDMM(win.end)+' | Ch·∫ø ƒë·ªô hi·ªÉn th·ªã: '+viewMode+'\nToggles: ADR='+showADR+' REV='+showREV+' ‚Üí dispMode='+dispMode+'\nADR data: '+hasAdrData+' | Revenue data: '+hasRevData+'\nSummaryIndex='+_summaryIndex);
  }catch(err){ console.error(err); setStatus(err.message,true); }
}

async function exportPNG(){
  try{
    const gd = document.getElementById('chart');
    if(_summaryIndex==null || !_annotationsBackup){ await Plotly.downloadImage(gd,{format:'png',filename:'chart'}); return; }
    await Plotly.relayout(gd, {'annotations': _annotationsBackup.filter((_,i)=> i!==_summaryIndex)});
    const filename = (document.getElementById('titleH1').innerText || 'chart').replace(/\s+/g,'_') + '_noSummary';
    await Plotly.downloadImage(gd,{format:'png',filename:filename});
    await Plotly.relayout(gd, {'annotations': _annotationsBackup});
  }catch(e){ console.error(e); setStatus('Xu·∫•t PNG l·ªói: '+e.message, true); }
}

// UI
document.getElementById('hotelSelect').addEventListener('change', ()=>{ const p=PRESETS[document.getElementById('hotelSelect').value]; document.getElementById('csvUrl').value=p.csv; document.getElementById('titleH1').innerText=p.title; });
document.getElementById('renderBtn').addEventListener('click', render);
document.getElementById('toggleADR').addEventListener('change', render);
document.getElementById('toggleREV').addEventListener('change', render);
document.getElementById('modeSelect').addEventListener('change', render);
document.getElementById('exportBtn').addEventListener('click', exportPNG);

// Init defaults + auto-render TBH
(function init(){
  const p=PRESETS['TBH'];
  document.getElementById('hotelSelect').value='TBH';
  document.getElementById('csvUrl').value=p.csv;
  document.getElementById('titleH1').innerText=p.title;
  const today=new Date(); const yyyy=today.getFullYear(); const mm=('0'+(today.getMonth()+1)).slice(-2); const dd=('0'+today.getDate()).slice(-2);
  document.getElementById('meetingDate').value = yyyy+'-'+mm+'-'+dd;
  render();
})();
</script>
</body>
</html>