<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chuy·∫øn Bay ƒê·∫øn Ph√∫ Qu·ªëc</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chrono-node/1.3.11/chrono.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.15.0/Recharts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .custom-legend {
      font-size: 8px !important;
    }
    .custom-tooltip {
      font-size: 8px !important;
    }
    .pie-table {
      font-size: 13px !important;
    }
    .animate-row {
      animation: fadeInUp 0.6s ease-out forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    .animate-row:nth-child(1) { animation-delay: 0.1s; }
    .animate-row:nth-child(2) { animation-delay: 0.2s; }
    .animate-row:nth-child(3) { animation-delay: 0.3s; }
    .animate-row:nth-child(4) { animation-delay: 0.4s; }
    .animate-row:nth-child(5) { animation-delay: 0.5s; }
    .animate-row:nth-child(6) { animation-delay: 0.6s; }
    .animate-row:nth-child(7) { animation-delay: 0.7s; }
    .animate-row:nth-child(8) { animation-delay: 0.8s; }
    .animate-row:nth-child(9) { animation-delay: 0.9s; }
    .animate-row:nth-child(10) { animation-delay: 1s; }
    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .table-container {
      overflow: hidden;
    }
    #password-form {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    #password-form form {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    #password-form input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
    }
    #password-form button {
      width: 100%;
      padding: 0.75rem;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 0.5rem;
      font-size: 1rem;
      cursor: pointer;
    }
    #password-form button:hover {
      background: #5a67d8;
    }
    #error-msg {
      color: #e53e3e;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    #dashboard {
      display: none;
    }
    .no-data-msg {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 2rem;
    }
    .footer-text {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 1rem;
    }
    /* Larger font for pie labels */
    .recharts-pie-label-text {
      font-size: 12px !important;
      fill: #000 !important;
    }
    /* Larger pie for charts 2,3,4 */
    .small-pie .recharts-pie {
      transform: scale(1) !important;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Password Form -->
  <div id="password-form">
    <form id="password-input-form">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p</h2>
      <input type="password" id="password-input" placeholder="M·∫≠t kh·∫©u" required />
      <button type="submit">X√°c nh·∫≠n</button>
      <div id="error-msg"></div>
      <p class="footer-text">Written by Mr √Åi Tr√¨ - 0903 049955</p>
    </form>
  </div>

  <!-- Dashboard Content -->
  <div id="dashboard">
    <div id="root" class="container mx-auto p-4"></div>
  </div>

  <script>
    // Password protection logic
    const correctPassword = '123456';
    const form = document.getElementById('password-input-form');
    const input = document.getElementById('password-input');
    const errorMsg = document.getElementById('error-msg');
    const dashboard = document.getElementById('dashboard');
    const passwordForm = document.getElementById('password-form');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const enteredPass = input.value.trim();
      if (enteredPass === correctPassword) {
        passwordForm.style.display = 'none';
        dashboard.style.display = 'block';
        // Delay render ƒë·ªÉ script Babel load xong (tƒÉng l√™n 1s ƒë·ªÉ fix TypeError)
        setTimeout(() => {
          if (window.App && window.ReactDOM && window.ReactDOM.createRoot) {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(window.App));
          } else {
            console.error('App or React ch∆∞a load. Reload trang.');
            document.getElementById('root').innerHTML = '<div class="text-center text-red-500">L·ªói load dashboard. Reload trang v√† th·ª≠ l·∫°i.</div>';
          }
        }, 1000);
      } else {
        errorMsg.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Vui l√≤ng th·ª≠ l·∫°i.';
        input.value = '';
        input.focus();
      }
    });

    // Auto-focus input sau khi DOM ready
    window.addEventListener('load', () => { input.focus(); });
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { PieChart, Pie, Tooltip, Legend, Cell, ResponsiveContainer, LineChart, Line, XAxis, YAxis, CartesianGrid, Label } = Recharts;

    const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#A28EFF', '#FF4D4F', '#4CAF50', '#FF6F61', '#6B7280', '#AB47BC', '#F97316', '#10B981'];

    const parseDate = (dateStr) => {
      return new Date(dateStr);
    };

    const parseTimeToFraction = (timeStr) => {
      if (!timeStr || timeStr === 'Kh√¥ng x√°c ƒë·ªãnh') return 0;
      const [hours, minutes] = timeStr.split(':').map(Number);
      return (hours + minutes / 60) / 24;
    };

    const fractionToTime = (fraction) => {
      if (isNaN(fraction)) return 'Kh√¥ng x√°c ƒë·ªãnh';
      const hours = Math.floor(fraction * 24);
      const minutes = Math.round((fraction * 24 - hours) * 60);
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    };

    const normalizeCityName = (city) => {
      if (city === 'Danang') return 'Da Nang';
      return city.trim();
    };

    const cleanCountryName = (countryStr) => {
      if (!countryStr) return 'Kh√¥ng x√°c ƒë·ªãnh';
      const parts = countryStr.split('|');
      if (parts.length > 1) {
        return parts[1].trim();
      }
      return countryStr.trim();
    };

    const processAndCleanData = (data) => {
      return data
        .filter(row => row['STT'] && row['Ng√†y'] && row['Th√†nh ph·ªë'] && row['Qu·ªëc gia'])
        .map(row => ({
          stt: parseInt(row['STT']) || 0,
          date: parseDate(row['Ng√†y']),
          airline: row['H√£ng bay'] ? row['H√£ng bay'].trim() : 'Kh√¥ng x√°c ƒë·ªãnh',
          city: normalizeCityName(row['Th√†nh ph·ªë'] || 'Kh√¥ng x√°c ƒë·ªãnh'),
          country: cleanCountryName(row['Qu·ªëc gia']),
          time: fractionToTime(parseTimeToFraction(row['TIME'])),
          flightNo: row['Flight No'] ? row['Flight No'].trim().replace(/^"|"$/g, '') : 'N/A',
          isDomestic: row['Domestic'] === 'X',
          isInternational: row['International'] === 'X'
        }));
    };

    const aggregateData = (data, groupBy, startDate = null, endDate = null) => {
      const counts = {};
      data.forEach(row => {
        const rowDate = row.date;
        if (startDate && endDate) {
          if (rowDate < startDate || rowDate > endDate) return;
        }
        const key = row[groupBy];
        counts[key] = (counts[key] || 0) + 1;
      });

      const sorted = Object.entries(counts)
        .sort((a, b) => b[1] - a[1]);
      return sorted.map(([name, value], index) => ({ name, value, stt: index + 1 }));
    };

    const aggregateDomesticInternational = (data, startDate = null, endDate = null) => {
      let domestic = 0, international = 0;
      data.forEach(row => {
        const rowDate = row.date;
        if (startDate && endDate) {
          if (rowDate < startDate || rowDate > endDate) return;
        }
        if (row.isDomestic) domestic++;
        if (row.isInternational) international++;
      });
      return [
        { name: 'N·ªôi ƒë·ªãa', value: domestic, stt: 1 },
        { name: 'Qu·ªëc t·∫ø', value: international, stt: 2 }
      ].filter(item => item.value > 0);
    };

    const getTopInternationalCityAndCountry = (data, startDate = null, endDate = null) => {
      const cityCounts = {};
      const countryCounts = {};
      const cityToCountry = {};

      data.forEach(row => {
        const rowDate = row.date;
        if (startDate && endDate) {
          if (rowDate < startDate || rowDate > endDate) return;
        }
        if (row.isInternational) {
          const city = row.city;
          const country = row.country;
          cityCounts[city] = (cityCounts[city] || 0) + 1;
          countryCounts[country] = (countryCounts[country] || 0) + 1;
          cityToCountry[city] = country;
        }
      });

      const topCountryEntry = Object.entries(countryCounts).sort((a, b) => b[1] - a[1])[0];
      const topCities = Object.entries(cityCounts)
        .filter(([city]) => cityToCountry[city] === topCountryEntry?.[0])
        .sort((a, b) => b[1] - a[1])
        .map(([name, count]) => ({ name, count }));

      const topCityEntry = Object.entries(cityCounts).sort((a, b) => b[1] - a[1])[0];
      const topCity = topCityEntry ? { name: topCityEntry[0], count: topCityEntry[1], country: cityToCountry[topCityEntry[0]] } : null;

      return {
        topCity,
        topCountry: topCountryEntry ? { name: topCountryEntry[0], count: topCountryEntry[1], cities: topCities } : null
      };
    };

    const aggregateCisCountries = (data, startDate = null, endDate = null) => {
      const cisCountryNames = ['Russia', 'Russian Federation', 'Nga', 'Belarus', 'Kazakhstan', 'Uzbekistan'];
      const results = [];
      cisCountryNames.forEach((countryName, index) => {
        const filtered = data.filter(row => row.country === countryName && row.isInternational && row.date >= (startDate || new Date(0)) && row.date <= (endDate || new Date()));
        const cityCounts = {};
        filtered.forEach(row => {
          cityCounts[row.city] = (cityCounts[row.city] || 0) + 1;
        });
        const total = filtered.length;
        const cities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).map(([name, count]) => ({ name, count }));
        if (total > 0) {
          results.push({
            name: countryName,
            value: total,
            stt: index + 1,
            cities: cities
          });
        }
      });
      results.sort((a, b) => b.value - a.value);
      results.forEach((item, index) => { item.stt = index + 1; });
      return results;
    };

    const getCurrentMonthSheetName = (date) => {
      const monthNames = ['Th√°ng 01', 'Th√°ng 02', 'Th√°ng 03', 'Th√°ng 04', 'Th√°ng 05', 'Th√°ng 06',
                          'Th√°ng 07', 'Th√°ng 08', 'Th√°ng 09', 'Th√°ng 10', 'Th√°ng 11', 'Th√°ng 12'];
      return monthNames[date.getMonth()] + ' ' + date.getFullYear();
    };

    const aggregateFlightsByDate = (data, startDate, endDate) => {
      const counts = {};
      const domesticCounts = {};
      const internationalCounts = {};
      data.forEach(row => {
        const rowDate = row.date.toISOString().split('T')[0];
        if (row.date >= startDate && row.date <= endDate) {
          counts[rowDate] = (counts[rowDate] || 0) + 1;
          if (row.isDomestic) domesticCounts[rowDate] = (domesticCounts[rowDate] || 0) + 1;
          if (row.isInternational) internationalCounts[rowDate] = (internationalCounts[rowDate] || 0) + 1;
        }
      });
      return Object.keys(counts).map(date => ({
        date: date,
        totalFlights: counts[date],
        domesticFlights: domesticCounts[date] || 0,
        internationalFlights: internationalCounts[date] || 0
      }));
    };

    const App = () => {
      const today = new Date(); // Default to today: 21/10/2025
      const [data, setData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [sheetUrl, setSheetUrl] = useState('https://docs.google.com/spreadsheets/d/e/2PACX-1vSCxWcOum9YRkT2GVTri0K13drPhagUXCJd93mWGIiZvoXnn9gvvMv-o-KLu3bvFZGYSsegG4p7DKPs/pub?gid=0&single=true&output=csv');
      const [startDate, setStartDate] = useState(new Date(today.getFullYear(), today.getMonth(), today.getDate()));
      const [endDate, setEndDate] = useState(new Date(today.getFullYear(), today.getMonth(), today.getDate()));
      const [language, setLanguage] = useState('vi');
      const [showAllCis, setShowAllCis] = useState(false);
      const [showAllCountry, setShowAllCountry] = useState(false);
      const [showAllAirline, setShowAllAirline] = useState(false);
      const [showAllCity, setShowAllCity] = useState(false);
      const [noDataMsg, setNoDataMsg] = useState('');

      const translations = {
        vi: {
          title: 'Chuy·∫øn Bay ƒê·∫øn Ph√∫ Qu·ªëc - ',
          overviewTitle: 'T·ªîNG QUAN',
          cisTitle: 'Chuy·∫øn bay Charter CIS ƒë·∫øn Ph√∫ Qu·ªëc',
          cisDetailTitle: 'Danh s√°ch chi ti·∫øt Chuy·∫øn bay Charter CIS ƒë·∫øn Ph√∫ Qu·ªëc',
          cisTotal: 'T·ªïng s·ªë chuy·∫øn bay: {total}',
          more: 'Nhi·ªÅu h∆°n',
          less: 'Thu g·ªçn',
          noData: 'Kh√¥ng c√≥ chuy·∫øn bay CIS trong kho·∫£ng th·ªùi gian n√†y.',
          dateRange: 'T·ª´ {start} ƒë·∫øn {end}. T·ªïng c·ªông: {days} ng√†y.',
          categoryHeader: 'H·∫°ng m·ª•c',
          detailHeader: 'Th√¥ng tin t√≥m t·∫Øt',
          avgHeader: 'B√¨nh qu√¢n/ng√†y',
          sttHeader: 'STT',
          countryHeader: 'Qu·ªëc gia',
          dateHeader: 'Ng√†y',
          airlineHeader: 'H√£ng bay',
          cityHeader: 'Th√†nh ph·ªë',
          timeHeader: 'Th·ªùi gian',
          flightNoHeader: 'S·ªë hi·ªáu chuy·∫øn bay',
          pie1: '1. N·ªôi ƒë·ªãa vs Qu·ªëc t·∫ø',
          pie2: '2. Chuy·∫øn bay theo Qu·ªëc gia',
          pie3: '3. Chuy·∫øn bay theo H√£ng bay',
          pie4: '4. Chuy·∫øn bay theo Th√†nh ph·ªë',
          list: 'Danh s√°ch:',
          stt: 'STT',
          name: 'T√™n',
          flights: 'S·ªë chuy·∫øn',
          percentage: 'T·ª∑ l·ªá (%)',
          reload: 'T·∫£i l·∫°i d·ªØ li·ªáu',
          urlPlaceholder: 'Nh·∫≠p URL Google Sheets (CSV export)',
          loading: 'ƒêang t·∫£i d·ªØ li·ªáu chuy·∫øn bay...',
          fromDate: 'T·ª´ ng√†y',
          toDate: 'ƒê·∫øn ng√†y',
          timeline: 'Bi·ªÉu ƒë·ªì th·ªùi gian s·ªë chuy·∫øn bay',
          noDataOverview: 'Kh√¥ng c√≥ d·ªØ li·ªáu cho kho·∫£ng th·ªùi gian n√†y. Ki·ªÉm tra Google Sheet ho·∫∑c thay ƒë·ªïi ng√†y.',
          category1: 'T·ªïng s·ªë chuy·∫øn bay'
        },
        en: {
          title: 'Flight Dashboard - ',
          overviewTitle: 'OVERVIEW',
          cisTitle: 'CIS Charter Flights to Phu Quoc',
          cisDetailTitle: 'Detailed List of CIS Charter Flights to Phu Quoc',
          cisTotal: 'Total flights: {total}',
          more: 'More',
          less: 'Less',
          noData: 'No CIS flights in this time period.',
          dateRange: 'From {start} to {end}. Total: {days} days.',
          categoryHeader: 'Category',
          detailHeader: 'Summary',
          avgHeader: 'Average/day',
          sttHeader: 'No.',
          countryHeader: 'Country',
          dateHeader: 'Date',
          airlineHeader: 'Airline',
          cityHeader: 'City',
          timeHeader: 'Time',
          flightNoHeader: 'Flight No',
          pie1: '1. Domestic vs International',
          pie2: '2. Flights by Country',
          pie3: '3. Flights by Airline',
          pie4: '4. Flights by City',
          list: 'List:',
          stt: 'No.',
          name: 'Name',
          flights: 'Flights',
          percentage: 'Percentage (%)',
          reload: 'Reload data',
          urlPlaceholder: 'Enter Google Sheets URL (CSV export)',
          loading: 'Loading flight data...',
          fromDate: 'From date',
          toDate: 'To date',
          timeline: 'Timeline of flight numbers',
          noDataOverview: 'No data for this time period. Check Google Sheet or change dates.',
          category1: 'Total flights.'
        }
      };

      const t = (key, params = {}) => {
        let text = translations[language][key] || key;
        Object.keys(params).forEach(p => {
          text = text.replace(new RegExp(`{${p}}`, 'g'), params[p]);
        });
        return text;
      };

      const loadData = (url) => {
        setLoading(true);
        setNoDataMsg('');
        Papa.parse(url, {
          download: true,
          header: true,
          complete: (results) => {
            const processedData = processAndCleanData(results.data);
            setData(processedData);
            if (processedData.length === 0) {
              setNoDataMsg(t('noDataOverview'));
            }
            setLoading(false);
          },
          error: (err) => {
            console.error('L·ªói khi ph√¢n t√≠ch CSV:', err);
            setLoading(false);
            setNoDataMsg('L·ªói t·∫£i d·ªØ li·ªáu. Ki·ªÉm tra URL Google Sheets.');
            alert('L·ªói khi t·∫£i d·ªØ li·ªáu CSV. Vui l√≤ng ki·ªÉm tra URL ho·∫∑c ƒë·ªãnh d·∫°ng file.');
          }
        });
      };

      useEffect(() => {
        if (sheetUrl) {
          loadData(sheetUrl);
        }
      }, [sheetUrl]);

      const handleReload = () => {
        if (sheetUrl) {
          loadData(sheetUrl);
        } else {
          alert('Vui l√≤ng nh·∫≠p URL Google Sheets h·ª£p l·ªá!');
        }
      };

      const handleUrlChange = (e) => {
        setSheetUrl(e.target.value);
      };

      const getFilteredData = () => {
        const filtered = data.filter(row => {
          const rowDate = row.date;
          return rowDate >= startDate && rowDate <= endDate;
        });
        return filtered;
      };

      const getCisFlights = () => {
        const cisCountries = ['Russia', 'Russian Federation', 'Nga', 'Belarus', 'Kazakhstan', 'Uzbekistan'];
        return getFilteredData()
          .filter(row => row.isInternational && cisCountries.includes(row.country))
          .sort((a, b) => b.date.getTime() - a.date.getTime() || parseTimeToFraction(b.time) - parseTimeToFraction(a.time));
      };

      const getCisDetailText = (item) => {
        const unit = language === 'vi' ? 'chuy·∫øn' : 'flights';
        return language === 'vi' ? `${item.value} ${unit}. Bay t·ª´:` : `${item.value} ${unit}. From:`;
      };

      const renderAnimatedTable = (rows, headers) => {
        return (
          <div className="table-container">
            <table className="w-full text-left border-collapse border border-gray-300 text-sm">
              <thead>
                <tr className="bg-gray-200">
                  {headers.map((header, idx) => (
                    <th key={idx} className="border border-gray-300 p-2">{header}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {rows.map((row, index) => (
                  <tr key={index} className="animate-row border-t border-gray-300">
                    {row.map((cell, cellIdx) => (
                      <td key={cellIdx} className="border border-gray-300 p-2">{cell}</td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        );
      };

      const renderPieChart = (data, title, key) => {
        const total = data.reduce((sum, item) => sum + item.value, 0);
        const formattedTitle = title.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
        const showLegend = !['airline', 'city'].includes(key);
        let displayData = data;
        let showMoreBtn = false;
        let showLessBtn = false;
        let [showAll, setShowAll] = [false, () => {}];

        if (key === 'country') {
          displayData = showAllCountry ? data : data.slice(0, 10);
          showMoreBtn = data.length > 10 && !showAllCountry;
          showLessBtn = showAllCountry;
          [showAll, setShowAll] = [showAllCountry, setShowAllCountry];
        } else if (key === 'airline') {
          displayData = showAllAirline ? data : data.slice(0, 10);
          showMoreBtn = data.length > 10 && !showAllAirline;
          showLessBtn = showAllAirline;
          [showAll, setShowAll] = [showAllAirline, setShowAllAirline];
        } else if (key === 'city') {
          displayData = showAllCity ? data : data.slice(0, 10);
          showMoreBtn = data.length > 10 && !showAllCity;
          showLessBtn = showAllCity;
          [showAll, setShowAll] = [showAllCity, setShowAllCity];
        }

        const isSmallPie = ['country', 'airline', 'city'].includes(key);
        const customLabel = (entry) => {
          const percentage = total > 0 ? ((entry.value / total) * 100).toFixed(1) : 0;
          const nameDisplay = isSmallPie ? entry.name.slice(0, 8) : entry.name;
          return `${nameDisplay} ${percentage}%`;
        };
        const outerRadius = isSmallPie ? 100 : 100;

        return (
          <div className={isSmallPie ? 'small-pie' : ''} className="bg-white p-4 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold text-center mb-4">{formattedTitle}</h3>
            <ResponsiveContainer width="100%" height={isSmallPie ? 400 : 300}>
              <PieChart>
                <Pie
                  data={displayData}
                  dataKey="value"
                  nameKey="name"
                  cx="50%"
                  cy="50%"
                  outerRadius={outerRadius}
                  fill="#8884d8"
                  label={customLabel}
                  labelLine={false}
                >
                  {displayData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip className="custom-tooltip" />
                {showLegend && <Legend className="custom-legend" />}
              </PieChart>
            </ResponsiveContainer>
            <div className="mt-4">
              <h4 className="text-md font-semibold mb-2">{t('list')}</h4>
              <table className="w-full text-left border-collapse border border-gray-300 pie-table">
                <thead>
                  <tr className="bg-gray-200">
                    <th className="border border-gray-300 p-1">{t('stt')}</th>
                    <th className="border border-gray-300 p-1">{t('name')}</th>
                    <th className="border border-gray-300 p-1">{t('flights')}</th>
                    <th className="border border-gray-300 p-1">{t('percentage')}</th>
                  </tr>
                </thead>
                <tbody>
                  {displayData.map((item, index) => (
                    <tr key={`cell-${index}`} className="border-t border-gray-300">
                      <td className="border border-gray-300 p-1">{item.stt}</td>
                      <td className="border border-gray-300 p-1">{item.name}</td>
                      <td className="border border-gray-300 p-1">{item.value}</td>
                      <td className="border border-gray-300 p-1">{total > 0 ? ((item.value / total) * 100).toFixed(2) : '0'}%</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {showMoreBtn && (
                <button
                  className="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm"
                  onClick={() => setShowAll(true)}
                >
                  {t('more')}
                </button>
              )}
              {showLessBtn && (
                <button
                  className="mt-2 bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded text-sm"
                  onClick={() => setShowAll(false)}
                >
                  {t('less')}
                </button>
              )}
              {key === 'domesticInternational' && (
                <div className="mt-4">
                  {renderLineChart(aggregateFlightsByDate(getFilteredData(), startDate, endDate), t('timeline'))}
                </div>
              )}
            </div>
          </div>
        );
      };

      const renderLineChart = (data, title) => {
        const formattedTitle = title.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
        return (
          <div className="bg-white p-4 rounded-lg shadow-md">
            <h3 className="text-lg font-semibold text-center mb-4">{formattedTitle}</h3>
            <ResponsiveContainer width="100%" height={200}>
              <LineChart data={data}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis 
                  dataKey="date" 
                  type="category" 
                  allowDuplicatedCategory={false}
                />
                <YAxis>
                  <Label angle={270} position="left" style={{ textAnchor: 'middle' }} value="S·ªë chuy·∫øn bay" />
                </YAxis>
                <Tooltip />
                <Legend className="custom-legend" />
                <Line type="monotone" dataKey="totalFlights" stroke="#8884d8" name="T·ªïng s·ªë chuy·∫øn" />
                <Line type="monotone" dataKey="domesticFlights" stroke="#00C49F" name="N·ªôi ƒë·ªãa" />
                <Line type="monotone" dataKey="internationalFlights" stroke="#FFBB28" name="Qu·ªëc t·∫ø" />
              </LineChart>
            </ResponsiveContainer>
            <p className="text-sm text-gray-600 mt-2">Bi·ªÉu ƒë·ªì hi·ªÉn th·ªã s·ªë l∆∞·ª£ng chuy·∫øn bay theo ng√†y trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
          </div>
        );
      };

      if (loading) {
        return <div className="text-center text-xl">{t('loading')}</div>;
      }

      const filteredData = getFilteredData();
      const totalFlights = filteredData.length;
      const numDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const showAvg = numDays > 1;
      const avgTotal = showAvg ? Math.round(totalFlights / numDays) : '';

      if (totalFlights === 0 && noDataMsg) {
        return <div className="no-data-msg">{noDataMsg}</div>;
      }

      const domesticInternational = aggregateDomesticInternational(filteredData, startDate, endDate);
      const totalDomesticIntl = domesticInternational.reduce((sum, item) => sum + item.value, 0);
      const domesticPct = totalDomesticIntl > 0 ? ((domesticInternational.find(item => item.name === 'N·ªôi ƒë·ªãa')?.value || 0) / totalDomesticIntl * 100).toFixed(1) : 0;
      const intlPct = totalDomesticIntl > 0 ? ((domesticInternational.find(item => item.name === 'Qu·ªëc t·∫ø')?.value || 0) / totalDomesticIntl * 100).toFixed(1) : 0;
      const byCountry = aggregateData(filteredData, 'country', startDate, endDate);
      const byAirline = aggregateData(filteredData, 'airline', startDate, endDate);
      const byCity = aggregateData(filteredData, 'city', startDate, endDate);
      const cisData = aggregateCisCountries(filteredData, startDate, endDate);
      const cisFlights = getCisFlights();

      const topDomesticData = aggregateData(filteredData.filter(r => r.isDomestic), 'city', startDate, endDate);
      const topIntlCities = aggregateData(filteredData.filter(r => r.isInternational), 'city', startDate, endDate);

      const formatDate = (date) => {
        return `${date.getDate()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
      };

      const startDateFormatted = formatDate(startDate);
      const endDateFormatted = formatDate(endDate);

      const displayedCisFlights = showAllCis ? cisFlights : cisFlights.slice(0, 5);

      const renderTop3Summary = (topData, type) => {
        const unit = language === 'vi' ? 'chuy·∫øn' : 'flights';
        const avgText = language === 'vi' ? 'chuy·∫øn/ng√†y' : 'flights/day';
        const items = topData.slice(0, 3).map((item, index) => {
          const avgItem = showAvg ? ` (‚âà ${Math.round(item.value / numDays)} ${avgText})` : '';
          return (
            <span key={index}>
              {index + 1}. <strong>{item.name}</strong> ‚Äì {item.value} {unit}{avgItem}
            </span>
          );
        });
        return (
          <span className="text-sm">
            {items.reduce((prev, curr, idx) => {
              if (idx === 0) return curr;
              return (
                <>
                  {prev}; {curr}
                </>
              );
            }, null)}
          </span>
        );
      };

      const overviewHeaders = [t('categoryHeader'), t('detailHeader')];
      const overviewRows = [
        [`‚úàÔ∏è ${t('category1')}`, `${totalFlights} ${language === 'vi' ? 'chuy·∫øn' : 'flights'}${showAvg ? ` (‚âà ${avgTotal} ${language === 'vi' ? 'chuy·∫øn/ng√†y' : 'flights/day'})` : ''}${totalDomesticIntl > 0 ? ` (${domesticPct}% ${language === 'vi' ? 'N·ªôi ƒë·ªãa' : 'Domestic'}, ${intlPct}% ${language === 'vi' ? 'Qu·ªëc t·∫ø' : 'International'})` : ''}`],
        ['üè¢ Top 3 H√£ng bay', renderTop3Summary(byAirline, 'airline')],
        ['üáªüá≥ Top 3 ƒê∆∞·ªùng bay N·ªôi ƒë·ªãa', renderTop3Summary(topDomesticData, 'domestic')],
        ['üåè Top 3 ƒê∆∞·ªùng bay Qu·ªëc t·∫ø', renderTop3Summary(topIntlCities, 'international')],
        ['üåè Top 3 Qu·ªëc gia ƒë·∫øn', renderTop3Summary(byCountry, 'country')]
      ];

      const cisHeaders = [t('sttHeader'), t('countryHeader'), t('detailHeader'), t('avgHeader')];
      const cisRows = cisData.map(item => [
        item.stt,
        <strong>{item.name}</strong>,
        <>{getCisDetailText(item)}{' '}
          {item.cities && item.cities.length > 0 ? (
            item.cities.map((city, idx) => (
              <span key={idx}>
                <strong>{city.name}</strong>, {city.count} {language === 'vi' ? 'chuy·∫øn' : 'flights'}{idx < item.cities.length - 1 ? '; ' : ''}
              </span>
            ))
          ) : (
            language === 'vi' ? 'Kh√¥ng c√≥ d·ªØ li·ªáu' : 'No data'
          )}</>,
        showAvg ? `${Math.round(item.value / numDays)} ${language === 'vi' ? 'chuy·∫øn/ng√†y' : 'flights/day'}` : ''
      ]);

      const cisDetailHeaders = [t('stt'), t('dateHeader'), t('airlineHeader'), t('cityHeader'), t('countryHeader'), t('timeHeader'), t('flightNoHeader')];
      const cisDetailRows = displayedCisFlights.map((row, index) => [
        index + 1,
        formatDate(row.date),
        <strong>{row.airline}</strong>,
        <strong>{row.city}</strong>,
        <strong>{row.country}</strong>,
        row.time,
        row.flightNo
      ]);

      return (
        <div className="space-y-8">
          <h1 className="text-3xl font-bold text-center text-blue-600 mb-4">{t('title')}{getCurrentMonthSheetName(startDate)}</h1>
          <div className="flex flex-wrap items-center justify-center space-x-4 space-y-2 bg-blue-600 text-white p-4 rounded-lg">
            <label className="whitespace-nowrap">{t('fromDate')}: </label>
            <input
              type="date"
              className="p-2 rounded text-black"
              value={startDate.toISOString().split('T')[0]}
              onChange={(e) => setStartDate(new Date(e.target.value))}
              min="2025-10-01"
              max="2025-12-31"
            />
            <label className="whitespace-nowrap">{t('toDate')}: </label>
            <input
              type="date"
              className="p-2 rounded text-black"
              value={endDate.toISOString().split('T')[0]}
              onChange={(e) => setEndDate(new Date(e.target.value))}
              min="2025-10-01"
              max="2025-12-31"
            />
            <input
              type="text"
              className="p-2 rounded text-black"
              value={sheetUrl}
              onChange={handleUrlChange}
              placeholder={t('urlPlaceholder')}
            />
            <button
              className="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
              onClick={handleReload}
            >
              {t('reload')}
            </button>
            <button
              className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
              onClick={() => setLanguage(language === 'vi' ? 'en' : 'vi')}
            >
              {language === 'vi' ? 'Switch to English' : 'Chuy·ªÉn sang Ti·∫øng Vi·ªát'}
            </button>
          </div>

          <div className="bg-white p-4 rounded-lg shadow-md">
            <h2 className="text-xl font-semibold mb-4">{t('overviewTitle')}</h2>
            <p className="mb-4 text-sm">T·ª´ {startDateFormatted} ƒë·∫øn {endDateFormatted}. T·ªïng c·ªông: <span className="font-bold">{numDays} ng√†y.</span></p>
            {renderAnimatedTable(overviewRows, overviewHeaders)}

            <h3 className="text-lg font-semibold mb-2 mt-6">{t('cisTitle')}</h3>
            <p className="mb-2 text-sm font-semibold">{t('cisTotal', { total: cisFlights.length })}</p>
            {renderAnimatedTable(cisRows, cisHeaders)}

            <h3 className="text-lg font-semibold mb-2 mt-6">{t('cisDetailTitle')}</h3>
            {cisFlights.length > 0 ? (
              <>
                {renderAnimatedTable(cisDetailRows, cisDetailHeaders)}
                {cisFlights.length > 5 && !showAllCis && (
                  <button
                    className="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm"
                    onClick={() => setShowAllCis(true)}
                  >
                    {t('more')}
                  </button>
                )}
                {showAllCis && (
                  <button
                    className="mt-2 bg-gray-500 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded text-sm"
                    onClick={() => setShowAllCis(false)}
                  >
                    {t('less')}
                  </button>
                )}
              </>
            ) : (
              <p className="text-sm text-gray-600">{t('noData')}</p>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {renderPieChart(domesticInternational, t('pie1'), 'domesticInternational')}
            {renderPieChart(byCountry, t('pie2'), 'country')}
            {renderPieChart(byAirline, t('pie3'), 'airline')}
            {renderPieChart(byCity, t('pie4'), 'city')}
          </div>

          <footer className="text-center text-xs text-gray-500 mt-8 pt-4">
            <strong>Written by Mr √Åi Tr√¨ @2025. Mob.: 0903 049955</strong>
          </footer>
        </div>
      );
    };

    // Export App to global scope
    window.App = App;
  </script>
</body>
</html>
